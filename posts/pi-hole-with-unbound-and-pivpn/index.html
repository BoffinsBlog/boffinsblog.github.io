<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Pi-hole with Unbound and PiVPN | Boffins Blog</title>
<meta name="keywords" content="Linux, Raspberry Pi, Self Hosting, Software, Web-Servers">
<meta name="description" content="Install Pi-hole as a DNS sinkhole to block ads and trackers, Unbound as a recursive DNS resolver and PiVPN.">
<meta name="author" content="Boffin">
<link rel="canonical" href="https://boffinsblog.github.io/posts/pi-hole-with-unbound-and-pivpn/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e13be8719bbabf4005d0d2b0f19dba897f7d41b2e807b64c47ee1436d126ab01.css" integrity="sha256-4TvocZu6v0AF0NKw8Z26iX99QbLoB7ZMR&#43;4UNtEmqwE=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://boffinsblog.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://boffinsblog.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://boffinsblog.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://boffinsblog.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://boffinsblog.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://boffinsblog.github.io/posts/pi-hole-with-unbound-and-pivpn/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:url" content="https://boffinsblog.github.io/posts/pi-hole-with-unbound-and-pivpn/">
  <meta property="og:site_name" content="Boffins Blog">
  <meta property="og:title" content="Pi-hole with Unbound and PiVPN">
  <meta property="og:description" content="Install Pi-hole as a DNS sinkhole to block ads and trackers, Unbound as a recursive DNS resolver and PiVPN.">
  <meta property="og:locale" content="en-gb">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-10-07T17:48:02+01:00">
    <meta property="article:modified_time" content="2023-10-07T17:48:02+01:00">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Raspberry Pi">
    <meta property="article:tag" content="Self Hosting">
    <meta property="article:tag" content="Software">
    <meta property="article:tag" content="Web-Servers">
    <meta property="og:image" content="https://boffinsblog.github.io/posts/pi-hole-with-unbound-and-pivpn/01_Pi-hole_Traffic_Graph_Screenshot.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://boffinsblog.github.io/posts/pi-hole-with-unbound-and-pivpn/01_Pi-hole_Traffic_Graph_Screenshot.webp">
<meta name="twitter:title" content="Pi-hole with Unbound and PiVPN">
<meta name="twitter:description" content="Install Pi-hole as a DNS sinkhole to block ads and trackers, Unbound as a recursive DNS resolver and PiVPN.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://boffinsblog.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Pi-hole with Unbound and PiVPN",
      "item": "https://boffinsblog.github.io/posts/pi-hole-with-unbound-and-pivpn/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Pi-hole with Unbound and PiVPN",
  "name": "Pi-hole with Unbound and PiVPN",
  "description": "Install Pi-hole as a DNS sinkhole to block ads and trackers, Unbound as a recursive DNS resolver and PiVPN.",
  "keywords": [
    "Linux", "Raspberry Pi", "Self Hosting", "Software", "Web-Servers"
  ],
  "articleBody": "Shut your Pi-hole! There are a bunch of posts similar to this one but I couldn’t find one that brought all of these elements together, so, here is my brain dump on how to install Pi-hole with Unbound and PiVPN.\nPi-hole with Unbound and PiVPN – Update Everything Ensure that the system is up to date:\nsudo apt update \u0026\u0026 sudo apt upgrade\nFirst, install Pi-hole The Pi-hole[®] is a DNS sinkhole that protects your devices from unwanted content, without installing any client-side software.\nhttps://docs.pi-hole.net/ One-Step Automated Install Start the process by typing the following in a Terminal:\ncurl -sSL https://install.pi-hole.net | bash\nThen, accept all the defaults.\nEither write down the generated password or change the password later by running ‘pihole -a -p‘ in a Terminal.\nAdd Pi-hole rules to ufw Firewall Pi-hole needs to both listen to and sometimes talk to the outside world.\nI use ‘ufw’ or ‘ Uncomplicated Firewall ‘ so I need to allow traffic to the Pi-hole ports:\nsudo ufw allow 53/tcp comment \"Pi-hole Port 53 tcp traffic\"\nsudo ufw allow 53/udp comment \"Pi-hole Port 53 udp traffic\"\nsudo ufw allow 67/tcp comment \"Pi-hole Port 67 tcp traffic\"\nsudo ufw allow 67/udp comment \"Pi-hole Port 67 udp traffic\"\nAlso add IPv6 Rules (include above IPv4 rules) sudo ufw allow 546:547/udp comment \"Pi-hole DHCP traffic\"\nTo delete old rules sudo ufw status verbose\nsudo ufw status numbered\nsudo ufw delete number_of_rule\nDHCP on the router can now be turned off.\nPi-hole Blocklists Generally the first step is to think about what you want to block on your network.\nThen, implement lists that satisfy the above.\nThis is a good overview of blocklists:\nhttps://www.avoidthehack.com/best-pihole-blocklists My Blocklists I subscribe to the ‘less is more’ ethos and have a few high quality curated lists rather than blocking millions of URLs.\nhttps://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn/hosts https://big.oisd.nl/ https://raw.githubusercontent.com/EnergizedProtection/EnergizedBlu/master/energized/blu.txt https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt https://phishing.army/download/phishing_army_blocklist_extended.txt Use nginx over lighttpd I already have a web server up and running (you are reading this because of it) so I don’t really need lighttpd running as well.\nsudo systemctl disable lighttpd\nsudo apt-get purge --auto-remove lighttpd\nsudo systemctl restart nginx\nsudo rm /var/www/html``/index.lighttpd.html\nOr, use both and edit lighttpd.conf and change the listening port:\nsudo nano /etc/lighttpd/lighttpd.conf\nFrom:\nserver.port = 80 To:\nserver.port = 8080 flush_pihole.sh I like bash scripts, so I obviously wrote one to:\nStop the pihole service\nFlush stale ’neighbouring’ leases\nFlush current leases\nRemove old lists\nRemove the query database and log (long term storage)\nRemove the dnsmasq log (short term storage)\nStart the pihole service\nUpdate Gravity\nRestart DNS\nIs pihole running\nPi-hole probably has a way to do all of this somewhere but I just like writing scripts.\nFirstly, create the script:\nsudo nano /etc/init.d/flush_pihole.sh\n#!/bin/bash clear # Stop the pihole service echo \"\" echo -e \"\\e[1;33mStop the pihole service...\\e[0m\" service pihole-FTL stop echo -e \"\\e[32mDone\\e[0m\" # Flush stale 'neighbouring' leases echo \"\" echo -e \"\\e[1;33mFlush stale 'neighbouring' leases...\\e[0m\" ip neigh flush nud stale echo -e \"\\e[32mDone\\e[0m\" # Flush current leases echo \"\" echo -e \"\\e[1;33mFlush current leases...\\e[0m\" rm /etc/pihole/dhcp.leases echo -e \"\\e[32mDone\\e[0m\" # Remove old lists echo \"\" echo -e \"\\e[1;33mRemove old lists...\\e[0m\" rm /etc/pihole/list.* echo -e \"\\e[32mDone\\e[0m\" # Remove the query database and log (long term storage) echo \"\" echo -e \"\\e[1;33mRemove the query database and log (long term storage)...\\e[0m\" rm /etc/pihole/pihole-FTL.db rm /etc/pihole/pihole-FTL.log echo -e \"\\e[32mDone\\e[0m\" # Remove the dnsmasq log (short term storage) echo \"\" echo -e \"\\e[1;33mRemove the dnsmasq log (short term storage)...\\e[0m\" rm /var/log/pihole.log echo -e \"\\e[32mDone\\e[0m\" # Start the pihole service echo \"\" echo -e \"\\e[1;33mStart the pihole service...\\e[0m\" service pihole-FTL start echo -e \"\\e[32mDone\\e[0m\" # Update Gravity echo \"\" echo -e \"\\e[1;33mUpdate Gravity...\\e[0m\" pihole -g echo -e \"\\e[32mDone\\e[0m\" # Restart DNS echo \"\" echo -e \"\\e[1;33mRestart DNS...\\e[0m\" pihole restartdns echo -e \"\\e[32mDone\\e[0m\" # Is pihole running echo -e \"\\e[1;33mIs pihole running...\\e[0m\" systemctl status --no-pager pihole-FTL echo -e \"\\e[32mDone\\e[0m\" echo \"\" Then, give the file the correct permissions:\nsudo chmod +x /etc/init.d/flush_pihole.sh\nFinally, add it to root cron and set it to run daily at midnight:\nsudo crontab -e\n# # Flush the Pi-hole logs \u0026 db also update Gravity daily at midnight 0 0 * * * sh /etc/init.d/flush_pihole.sh # Then, install Unbound Unbound is a validating, recursive, caching DNS resolver.\nhttps://nlnetlabs.nl/projects/unbound/about/ I followed the Pi-hole Unbound guide, and started with:\nsudo apt install unbound\nConfigure Unbound In a Terminal, type the following:\nsudo nano /etc/unbound/unbound.conf.d/pi-hole.conf\nThis will:\nListen only for queries from the local Pi-hole installation (on port 5335)\nListen for both UDP and TCP requests\nVerify DNSSEC signatures, discarding BOGUS domains\nApply a few security and privacy tricks\nserver: # If no logfile is specified, syslog is used # logfile: \"/var/log/unbound/unbound.log\" verbosity: 0 interface: 127.0.0.1 port: 5335 do-ip4: yes do-udp: yes do-tcp: yes # May be set to yes if you have IPv6 connectivity do-ip6: no # You want to leave this to no unless you have *native* IPv6. with 6to4 and # Terredo tunnels your web browser should favor IPv4 for the same reasons prefer-ip6: no # Use this only when you downloaded the list of primary root servers! # If you use the default dns-root-data package, unbound will find it automatically #root-hints: \"/var/lib/unbound/root.hints\" # Trust glue only if it is within the server's authority harden-glue: yes # Require DNSSEC data for trust-anchored zones, if such data is absent, the zone becomes BOGUS harden-dnssec-stripped: yes # Don't use Capitalization randomization as it known to cause DNSSEC issues sometimes # see https://discourse.pi-hole.net/t/unbound-stubby-or-dnscrypt-proxy/9378 for further details use-caps-for-id: no # Reduce EDNS reassembly buffer size. # IP fragmentation is unreliable on the Internet today, and can cause # transmission failures when large DNS messages are sent via UDP. Even # when fragmentation does work, it may not be secure; it is theoretically # possible to spoof parts of a fragmented DNS message, without easy # detection at the receiving end. Recently, there was an excellent study # \u003e\u003e\u003e Defragmenting DNS - Determining the optimal maximum UDP response size for DNS \u003c\u003c\u003c # by Axel Koolhaas, and Tjeerd Slokker (https://indico.dns-oarc.net/event/36/contributions/776/) # in collaboration with NLnet Labs explored DNS using real world data from the # the RIPE Atlas probes and the researchers suggested different values for # IPv4 and IPv6 and in different scenarios. They advise that servers should # be configured to limit DNS messages sent over UDP to a size that will not # trigger fragmentation on typical network links. DNS servers can switch # from UDP to TCP when a DNS response is too big to fit in this limited # buffer size. This value has also been suggested in DNS Flag Day 2020. edns-buffer-size: 1232 # Perform prefetching of close to expired message cache entries # This only applies to domains that have been frequently queried prefetch: yes # One thread should be sufficient, can be increased on beefy machines. In reality for most users running on small networks or on a single machine, it should be unnecessary to seek performance enhancement by increasing num-threads above 1. num-threads: 1 # Ensure kernel buffer is large enough to not lose messages in traffic spikes so-rcvbuf: 1m # Ensure privacy of local IP ranges private-address: 192.168.0.0/16 private-address: 169.254.0.0/16 private-address: 172.16.0.0/12 private-address: 10.0.0.0/8 private-address: fd00::/8 private-address: fe80::/10 Limit the packet size sudo nano /etc/dnsmasq.d/99-edns.conf\nedns-packet-max=1232 Restart Unbound sudo service unbound restart\nsudo service unbound status\nTest validation Type the following in a Terminal:\ndig fail01.dnssec.works @127.0.0.1 -p 5335\nThis first command should give a status report of SERVFAIL and no IP address.\nThen, type the following in a Terminal:\ndig dnssec.works @127.0.0.1 -p 5335\nThis second command should give NOERROR plus an IP address.\nConfigure Pi-hole to use Unbound Firstly, log in to the Pi-hole web interface:\nhttp://your_server_ip/admin/login.php\nPi-hole Unbound DNS Settings\nIn Settings | DNS First, Untick any existing Upstream DNS Servers.\nThen, add the Unbound settings.\nIn Upstream DNS Servers | Custom 1 (IPv4) Set to 127.0.0.1#5335\nDisable resolvconf.conf entry for unbound The why is from here and is required for Debian Bullseye+ releases.\nFirstly, check to see if the service is running:\nsystemctl is-active unbound-resolvconf.service\nIf it is, disable it:\nsudo systemctl disable --now unbound-resolvconf.service\nThen, restart Unbound:\nsudo service unbound restart\nsudo service unbound status\nThen, install PiVPN The simplest way to setup and manage a VPN,\ndesigned for Raspberry Pi™.\nhttps://www.pivpn.io/ One line install curl -L https://install.pivpn.io | bash\nThen, step through the screens, choosing:\nUser – Whatever_You_Want\nVPN – WireGuard (or OpenVPN, the choice is yours)\nPort – 51820\nDNS – ‘Your_Public_IP’\nunattended-upgrades – Yes\nRemember to forward Port 51820 (UDP traffic) on the Router to the server.\nReboot and add Profiles Firstly, start by adding a new client connection:\nsudo pivpn add\nThen, enter a name for the client.\nThen, to generate a QR code that can be scanned from a mobile device:\nsudo pivpn -qr\nCheck it’s all working Firstly, in a Terminal, check the “last seen” entry by running the following:\nsudo pivpn -c\nThen, check the Pi-hole web interface under ‘Tools | Network‘ to see if the VPN gets filtered, there should be entries for:\nWhatever_You_Want.pivpn That’s how to install Pi-hole with Unbound and PiVPN.\n",
  "wordCount" : "1518",
  "inLanguage": "en",
  "image":"https://boffinsblog.github.io/posts/pi-hole-with-unbound-and-pivpn/01_Pi-hole_Traffic_Graph_Screenshot.webp","datePublished": "2023-10-07T17:48:02+01:00",
  "dateModified": "2023-10-07T17:48:02+01:00",
  "author":{
    "@type": "Person",
    "name": "Boffin"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://boffinsblog.github.io/posts/pi-hole-with-unbound-and-pivpn/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Boffins Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://boffinsblog.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://boffinsblog.github.io/" accesskey="h" title="Boffins Blog (Alt + H)">Boffins Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://boffinsblog.github.io/categories/featured/" title="Featured">
                    <span>Featured</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://boffinsblog.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://boffinsblog.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Pi-hole with Unbound and PiVPN
    </h1>
    <div class="post-meta"><span title='2023-10-07 17:48:02 +0100 BST'>October 7, 2023</span>&nbsp;·&nbsp;<span>8 min</span>&nbsp;·&nbsp;<span>Boffin</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#shut-your-pi-hole" aria-label="Shut your Pi-hole!">Shut your Pi-hole!</a></li>
                <li>
                    <a href="#pi-hole-with-unbound-and-pivpn--update-everything" aria-label="Pi-hole with Unbound and PiVPN – Update Everything">Pi-hole with Unbound and PiVPN – Update Everything</a></li>
                <li>
                    <a href="#first-install-pi-hole" aria-label="First, install Pi-hole">First, install Pi-hole</a><ul>
                        
                <li>
                    <a href="#one-step-automated-install" aria-label="One-Step Automated Install">One-Step Automated Install</a></li>
                <li>
                    <a href="#add-pi-hole-rules-to-ufw-firewall" aria-label="Add Pi-hole rules to ufw Firewall">Add Pi-hole rules to ufw Firewall</a></li>
                <li>
                    <a href="#also-add-ipv6-rules-include-above-ipv4-rules" aria-label="Also add IPv6 Rules (include above IPv4 rules)">Also add IPv6 Rules (include above IPv4 rules)</a><ul>
                        
                <li>
                    <a href="#to-delete-old-rules" aria-label="To delete old rules">To delete old rules</a></li></ul>
                </li>
                <li>
                    <a href="#pi-hole-blocklists" aria-label="Pi-hole Blocklists">Pi-hole Blocklists</a></li>
                <li>
                    <a href="#my-blocklists" aria-label="My Blocklists">My Blocklists</a></li>
                <li>
                    <a href="#use-nginx-over-lighttpd" aria-label="Use nginx over lighttpd">Use nginx over lighttpd</a></li></ul>
                </li>
                <li>
                    <a href="#then-install-unbound" aria-label="Then, install Unbound">Then, install Unbound</a><ul>
                        
                <li>
                    <a href="#limit-the-packet-size" aria-label="Limit the packet size">Limit the packet size</a></li>
                <li>
                    <a href="#restart-unbound" aria-label="Restart Unbound">Restart Unbound</a></li>
                <li>
                    <a href="#test-validation" aria-label="Test validation">Test validation</a></li>
                <li>
                    <a href="#configure-pi-hole-to-use-unbound" aria-label="Configure Pi-hole to use Unbound">Configure Pi-hole to use Unbound</a><ul>
                        
                <li>
                    <a href="#in-settings--dns" aria-label="In Settings | DNS">In Settings | DNS</a></li>
                <li>
                    <a href="#in-upstream-dns-servers--custom-1-ipv4" aria-label="In Upstream DNS Servers | Custom 1 (IPv4)">In Upstream DNS Servers | Custom 1 (IPv4)</a></li></ul>
                </li>
                <li>
                    <a href="#disable-resolvconfconf-entry-for-unbound" aria-label="Disable resolvconf.conf entry for unbound">Disable resolvconf.conf entry for unbound</a></li></ul>
                </li>
                <li>
                    <a href="#then-install-pivpn" aria-label="Then, install PiVPN">Then, install PiVPN</a><ul>
                        
                <li>
                    <a href="#one-line-install" aria-label="One line install">One line install</a></li>
                <li>
                    <a href="#reboot-and-add-profiles" aria-label="Reboot and add Profiles">Reboot and add Profiles</a></li>
                <li>
                    <a href="#check-its-all-working" aria-label="Check it’s all working">Check it’s all working</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="shut-your-pi-hole">Shut your Pi-hole!<a hidden class="anchor" aria-hidden="true" href="#shut-your-pi-hole">#</a></h2>
<p>There are a bunch of posts similar to this one but I couldn’t find one that brought all of these elements together, so, here is my brain dump on how to install Pi-hole with Unbound and PiVPN.</p>
<h2 id="pi-hole-with-unbound-and-pivpn--update-everything">Pi-hole with Unbound and PiVPN – Update Everything<a hidden class="anchor" aria-hidden="true" href="#pi-hole-with-unbound-and-pivpn--update-everything">#</a></h2>
<p>Ensure that the system is up to date:</p>
<p><code>sudo apt update &amp;&amp; sudo apt upgrade</code></p>
<h2 id="first-install-pi-hole">First, install Pi-hole<a hidden class="anchor" aria-hidden="true" href="#first-install-pi-hole">#</a></h2>
<blockquote>
<p>The Pi-hole[®] is a 

<a href="https://en.wikipedia.org/wiki/DNS_Sinkhole" target="_blank" rel="nofollow noopener noreferrer">DNS sinkhole</a>
 that protects your devices from unwanted content, without installing any client-side software.</p>
<p><em>

<a href="https://docs.pi-hole.net/" target="_blank" rel="nofollow noopener noreferrer">https://docs.pi-hole.net/</a>
</em></p></blockquote>
<h3 id="one-step-automated-install">One-Step Automated Install<a hidden class="anchor" aria-hidden="true" href="#one-step-automated-install">#</a></h3>
<p>Start the process by typing the following in a Terminal:</p>
<p><code>curl -sSL https://install.pi-hole.net | bash</code></p>
<p>Then, accept all the defaults.</p>
<p>Either write down the generated password or change the password later by running ‘<code>pihole -a -p</code>‘ in a Terminal.</p>
<h3 id="add-pi-hole-rules-to-ufw-firewall">Add Pi-hole rules to ufw Firewall<a hidden class="anchor" aria-hidden="true" href="#add-pi-hole-rules-to-ufw-firewall">#</a></h3>
<p>Pi-hole needs to both listen to and sometimes talk to the outside world.</p>
<p>I use ‘ufw’ or ‘

<a href="https://help.ubuntu.com/community/UFW" target="_blank" rel="nofollow noopener noreferrer">Uncomplicated Firewall</a>
‘ so I need to allow traffic to the Pi-hole ports:</p>
<p><code>sudo ufw allow 53/tcp comment &quot;Pi-hole Port 53 tcp traffic&quot;</code></p>
<p><code>sudo ufw allow 53/udp comment &quot;Pi-hole Port 53 udp traffic&quot;</code></p>
<p><code>sudo ufw allow 67/tcp comment &quot;Pi-hole Port 67 tcp traffic&quot;</code></p>
<p><code>sudo ufw allow 67/udp comment &quot;Pi-hole Port 67 udp traffic&quot;</code></p>
<h3 id="also-add-ipv6-rules-include-above-ipv4-rules">Also add IPv6 Rules (include above IPv4 rules)<a hidden class="anchor" aria-hidden="true" href="#also-add-ipv6-rules-include-above-ipv4-rules">#</a></h3>
<p><code>sudo ufw allow 546:547/udp comment &quot;Pi-hole DHCP traffic&quot;</code></p>
<h4 id="to-delete-old-rules">To delete old rules<a hidden class="anchor" aria-hidden="true" href="#to-delete-old-rules">#</a></h4>
<p><code>sudo ufw status verbose</code></p>
<p><code>sudo ufw status numbered</code></p>
<p><code>sudo ufw delete number_of_rule</code></p>
<p>DHCP on the router can now be turned off.</p>
<h3 id="pi-hole-blocklists">Pi-hole Blocklists<a hidden class="anchor" aria-hidden="true" href="#pi-hole-blocklists">#</a></h3>
<p>Generally the first step is to think about what <em>you</em> want to block on <em>your</em> network.</p>
<p>Then, implement lists that satisfy the above.</p>
<p>This is a good overview of blocklists:</p>
<p>

<a href="https://www.avoidthehack.com/best-pihole-blocklists" target="_blank" rel="nofollow noopener noreferrer">https://www.avoidthehack.com/best-pihole-blocklists</a>
</p>
<h3 id="my-blocklists">My Blocklists<a hidden class="anchor" aria-hidden="true" href="#my-blocklists">#</a></h3>
<p>I subscribe to the ‘less is more’ ethos and have a few high quality curated lists rather than blocking millions of URLs.</p>
<p>

<a href="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn/hosts" target="_blank" rel="nofollow noopener noreferrer">https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn/hosts</a>
</p>
<p>

<a href="https://big.oisd.nl/" target="_blank" rel="nofollow noopener noreferrer">https://big.oisd.nl/</a>
</p>
<p>

<a href="https://raw.githubusercontent.com/EnergizedProtection/EnergizedBlu/master/energized/blu.txt" target="_blank" rel="nofollow noopener noreferrer">https://raw.githubusercontent.com/EnergizedProtection/EnergizedBlu/master/energized/blu.txt</a>
</p>
<p>

<a href="https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt" target="_blank" rel="nofollow noopener noreferrer">https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt</a>
</p>
<p>

<a href="https://phishing.army/download/phishing_army_blocklist_extended.txt" target="_blank" rel="nofollow noopener noreferrer">https://phishing.army/download/phishing_army_blocklist_extended.txt</a>
</p>
<h3 id="use-nginx-over-lighttpd">Use nginx over lighttpd<a hidden class="anchor" aria-hidden="true" href="#use-nginx-over-lighttpd">#</a></h3>
<p>I already have a web server up and running (you are reading this because of it) so I don’t really need lighttpd running as well.</p>
<p><code>sudo systemctl disable lighttpd</code></p>
<p><code>sudo apt-get purge --auto-remove lighttpd</code></p>
<p><code>sudo systemctl restart nginx</code></p>
<p><code>sudo rm </code>/var/www/html``/<code>index.lighttpd.html</code></p>
<p>Or, use both and edit <code>lighttpd.conf</code> and change the listening port:</p>
<p><code>sudo nano /etc/lighttpd/lighttpd.conf</code></p>
<p>From:</p>
<pre tabindex="0"><code>server.port = 80
</code></pre><p>To:</p>
<pre tabindex="0"><code>server.port = 8080
</code></pre><h3 id="flush_">

<a href="https://github.com/BoffinsBlog/Pi-hole/blob/main/flush/flush_pihole.sh" target="_blank" rel="nofollow noopener noreferrer">flush_pihole.sh</a>
</h3>
<p>I like bash scripts, so I obviously wrote one to:</p>
<ul>
<li>
<p>Stop the pihole service</p>
</li>
<li>
<p>Flush stale &rsquo;neighbouring&rsquo; leases</p>
</li>
<li>
<p>Flush current leases</p>
</li>
<li>
<p>Remove old lists</p>
</li>
<li>
<p>Remove the query database and log (long term storage)</p>
</li>
<li>
<p>Remove the dnsmasq log (short term storage)</p>
</li>
<li>
<p>Start the pihole service</p>
</li>
<li>
<p>Update Gravity</p>
</li>
<li>
<p>Restart DNS</p>
</li>
<li>
<p>Is pihole running</p>
</li>
</ul>
<p>Pi-hole <em>probably</em> has a way to do all of this somewhere but I just like writing scripts.</p>
<p>Firstly, create the script:</p>
<p><code>sudo nano /etc/init.d/flush_pihole.sh</code></p>
<pre tabindex="0"><code>#!/bin/bash

clear

# Stop the pihole service
echo &#34;&#34;
echo -e &#34;\e[1;33mStop the pihole service...\e[0m&#34;
service pihole-FTL stop
echo -e &#34;\e[32mDone\e[0m&#34;

# Flush stale &#39;neighbouring&#39; leases
echo &#34;&#34;
echo -e &#34;\e[1;33mFlush stale &#39;neighbouring&#39; leases...\e[0m&#34;
ip neigh flush nud stale
echo -e &#34;\e[32mDone\e[0m&#34;

# Flush current leases
echo &#34;&#34;
echo -e &#34;\e[1;33mFlush current leases...\e[0m&#34;
rm /etc/pihole/dhcp.leases
echo -e &#34;\e[32mDone\e[0m&#34;

# Remove old lists
echo &#34;&#34;
echo -e &#34;\e[1;33mRemove old lists...\e[0m&#34;
rm /etc/pihole/list.*
echo -e &#34;\e[32mDone\e[0m&#34;

# Remove the query database and log (long term storage)
echo &#34;&#34;
echo -e &#34;\e[1;33mRemove the query database and log (long term storage)...\e[0m&#34;
rm /etc/pihole/pihole-FTL.db
rm /etc/pihole/pihole-FTL.log
echo -e &#34;\e[32mDone\e[0m&#34;

# Remove the dnsmasq log (short term storage)
echo &#34;&#34;
echo -e &#34;\e[1;33mRemove the dnsmasq log (short term storage)...\e[0m&#34;
rm /var/log/pihole.log
echo -e &#34;\e[32mDone\e[0m&#34;

# Start the pihole service
echo &#34;&#34;
echo -e &#34;\e[1;33mStart the pihole service...\e[0m&#34;
service pihole-FTL start
echo -e &#34;\e[32mDone\e[0m&#34;

# Update Gravity
echo &#34;&#34;
echo -e &#34;\e[1;33mUpdate Gravity...\e[0m&#34;
pihole -g
echo -e &#34;\e[32mDone\e[0m&#34;

# Restart DNS
echo &#34;&#34;
echo -e &#34;\e[1;33mRestart DNS...\e[0m&#34;
pihole restartdns
echo -e &#34;\e[32mDone\e[0m&#34;

# Is pihole running
echo -e &#34;\e[1;33mIs pihole running...\e[0m&#34;
systemctl status --no-pager pihole-FTL
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;
</code></pre><p>Then, give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/flush_pihole.sh</code></p>
<p>Finally, add it to root cron and set it to run daily at midnight:</p>
<p><code>sudo crontab -e</code></p>
<pre tabindex="0"><code>#
# Flush the Pi-hole logs &amp; db also update Gravity daily at midnight
0 0 * * * sh /etc/init.d/flush_pihole.sh
#
</code></pre><blockquote>
<h2 id="then-install-unbound">Then, install Unbound<a hidden class="anchor" aria-hidden="true" href="#then-install-unbound">#</a></h2></blockquote>
<blockquote>
<p>Unbound is a validating, recursive, caching DNS resolver.</p>
<p><em>

<a href="https://nlnetlabs.nl/projects/unbound/about/" target="_blank" rel="nofollow noopener noreferrer">https://nlnetlabs.nl/projects/unbound/about/</a>
</em></p></blockquote>
<p>I followed the 

<a href="https://docs.pi-hole.net/guides/dns/unbound/" target="_blank" rel="nofollow noopener noreferrer">Pi-hole Unbound</a>
 guide, and started with:</p>
<p><code>sudo apt install unbound</code></p>
<h3 id="configure-unbound">

<a href="https://github.com/BoffinsBlog/Pi-hole/blob/main/unbound/pi-hole.conf" target="_blank" rel="nofollow noopener noreferrer">Configure Unbound</a>
</h3>
<p>In a Terminal, type the following:</p>
<p><code>sudo nano /etc/unbound/unbound.conf.d/pi-hole.conf</code></p>
<p>This will:</p>
<ul>
<li>
<p>Listen only for queries from the local Pi-hole installation (on port 5335)</p>
</li>
<li>
<p>Listen for both UDP and TCP requests</p>
</li>
<li>
<p>Verify DNSSEC signatures, discarding BOGUS domains</p>
</li>
<li>
<p>Apply a few security and privacy tricks</p>
</li>
</ul>
<pre tabindex="0"><code>server:
    # If no logfile is specified, syslog is used
    # logfile: &#34;/var/log/unbound/unbound.log&#34;
    verbosity: 0

    interface: 127.0.0.1
    port: 5335
    do-ip4: yes
    do-udp: yes
    do-tcp: yes

    # May be set to yes if you have IPv6 connectivity
    do-ip6: no

    # You want to leave this to no unless you have *native* IPv6. with 6to4 and
    # Terredo tunnels your web browser should favor IPv4 for the same reasons
    prefer-ip6: no

    # Use this only when you downloaded the list of primary root servers!
    # If you use the default dns-root-data package, unbound will find it automatically
    #root-hints: &#34;/var/lib/unbound/root.hints&#34;

    # Trust glue only if it is within the server&#39;s authority
    harden-glue: yes

    # Require DNSSEC data for trust-anchored zones, if such data is absent, the zone becomes BOGUS
    harden-dnssec-stripped: yes

    # Don&#39;t use Capitalization randomization as it known to cause DNSSEC issues sometimes
    # see https://discourse.pi-hole.net/t/unbound-stubby-or-dnscrypt-proxy/9378 for further details
    use-caps-for-id: no

    # Reduce EDNS reassembly buffer size.
    # IP fragmentation is unreliable on the Internet today, and can cause
    # transmission failures when large DNS messages are sent via UDP. Even
    # when fragmentation does work, it may not be secure; it is theoretically
    # possible to spoof parts of a fragmented DNS message, without easy
    # detection at the receiving end. Recently, there was an excellent study
    # &gt;&gt;&gt; Defragmenting DNS - Determining the optimal maximum UDP response size for DNS &lt;&lt;&lt;
    # by Axel Koolhaas, and Tjeerd Slokker (https://indico.dns-oarc.net/event/36/contributions/776/)
    # in collaboration with NLnet Labs explored DNS using real world data from the
    # the RIPE Atlas probes and the researchers suggested different values for
    # IPv4 and IPv6 and in different scenarios. They advise that servers should
    # be configured to limit DNS messages sent over UDP to a size that will not
    # trigger fragmentation on typical network links. DNS servers can switch
    # from UDP to TCP when a DNS response is too big to fit in this limited
    # buffer size. This value has also been suggested in DNS Flag Day 2020.
    edns-buffer-size: 1232

    # Perform prefetching of close to expired message cache entries
    # This only applies to domains that have been frequently queried
    prefetch: yes

    # One thread should be sufficient, can be increased on beefy machines. In reality for most users running on small networks or on a single machine, it should be unnecessary to seek performance enhancement by increasing num-threads above 1.
    num-threads: 1

    # Ensure kernel buffer is large enough to not lose messages in traffic spikes
    so-rcvbuf: 1m

    # Ensure privacy of local IP ranges
    private-address: 192.168.0.0/16
    private-address: 169.254.0.0/16
    private-address: 172.16.0.0/12
    private-address: 10.0.0.0/8
    private-address: fd00::/8
    private-address: fe80::/10
</code></pre><h3 id="limit-the-packet-size">Limit the packet size<a hidden class="anchor" aria-hidden="true" href="#limit-the-packet-size">#</a></h3>
<p><code>sudo nano /etc/dnsmasq.d/99-edns.conf</code></p>
<pre tabindex="0"><code>edns-packet-max=1232
</code></pre><h3 id="restart-unbound">Restart Unbound<a hidden class="anchor" aria-hidden="true" href="#restart-unbound">#</a></h3>
<p><code>sudo service unbound restart</code></p>
<p><code>sudo service unbound status</code></p>
<h3 id="test-validation">Test validation<a hidden class="anchor" aria-hidden="true" href="#test-validation">#</a></h3>
<p>Type the following in a Terminal:</p>
<p><code>dig fail01.dnssec.works @127.0.0.1 -p 5335</code></p>
<p>This first command should give a status report of SERVFAIL and no IP address.</p>
<p>Then, type the following in a Terminal:</p>
<p><code>dig dnssec.works @127.0.0.1 -p 5335</code></p>
<p>This second command should give NOERROR plus an IP address.</p>
<h3 id="configure-pi-hole-to-use-unbound">Configure Pi-hole to use Unbound<a hidden class="anchor" aria-hidden="true" href="#configure-pi-hole-to-use-unbound">#</a></h3>
<p>Firstly, log in to the Pi-hole web interface:</p>
<p>http://your_server_ip/admin/login.php</p>
<p><img alt="A screenshot of the Pi-hole settings needed to use the Unbound recursive DNS server." loading="lazy" src="/posts/pi-hole-with-unbound-and-pivpn/02_Pi-hole_Unbound_DNS_Settings_Screenshot.webp#center" title="A screenshot of the Pi-hole settings needed to use the Unbound recursive DNS server.">
<em>Pi-hole Unbound DNS Settings</em></p>
<h4 id="in-settings--dns">In Settings | DNS<a hidden class="anchor" aria-hidden="true" href="#in-settings--dns">#</a></h4>
<p>First, Untick any existing Upstream DNS Servers.</p>
<p>Then, add the Unbound settings.</p>
<h4 id="in-upstream-dns-servers--custom-1-ipv4">In Upstream DNS Servers | Custom 1 (IPv4)<a hidden class="anchor" aria-hidden="true" href="#in-upstream-dns-servers--custom-1-ipv4">#</a></h4>
<p>Set to <code>127.0.0.1#5335</code></p>
<h3 id="disable-resolvconfconf-entry-for-unbound">Disable <code>resolvconf.conf</code> entry for unbound<a hidden class="anchor" aria-hidden="true" href="#disable-resolvconfconf-entry-for-unbound">#</a></h3>
<p>The why is from 

<a href="https://docs.pi-hole.net/guides/dns/unbound/#disable-resolvconf-for-unbound-optional" target="_blank" rel="nofollow noopener noreferrer">here</a>
 and is required for Debian Bullseye+ releases.</p>
<p>Firstly, check to see if the service is running:</p>
<p><code>systemctl is-active unbound-resolvconf.service</code></p>
<p>If it is, disable it:</p>
<p><code>sudo systemctl disable --now unbound-resolvconf.service</code></p>
<p>Then, restart Unbound:</p>
<p><code>sudo service unbound restart</code></p>
<p><code>sudo service unbound status</code></p>
<h2 id="then-install-pivpn">Then, install PiVPN<a hidden class="anchor" aria-hidden="true" href="#then-install-pivpn">#</a></h2>
<blockquote>
<p>The simplest way to setup and manage a VPN,<br>
designed for Raspberry Pi™.</p>
<p><em>

<a href="https://www.pivpn.io/" target="_blank" rel="nofollow noopener noreferrer">https://www.pivpn.io/</a>
</em></p></blockquote>
<h3 id="one-line-install">One line install<a hidden class="anchor" aria-hidden="true" href="#one-line-install">#</a></h3>
<p><code>curl -L https://install.pivpn.io | bash</code></p>
<p>Then, step through the screens, choosing:</p>
<p>User – Whatever_You_Want<br>
VPN – WireGuard (or OpenVPN, the choice is yours)<br>
Port – 51820<br>
DNS – &lsquo;Your_Public_IP&rsquo;<br>
unattended-upgrades – Yes</p>
<p><strong>Remember to forward Port 51820 (UDP traffic) on the Router to the server.</strong></p>
<h3 id="reboot-and-add-profiles">Reboot and add Profiles<a hidden class="anchor" aria-hidden="true" href="#reboot-and-add-profiles">#</a></h3>
<p>Firstly, start by adding a new client connection:</p>
<p><code>sudo pivpn add</code></p>
<p>Then, enter a name for the client.</p>
<p>Then, to generate a QR code that can be scanned from a mobile device:</p>
<p><code>sudo pivpn -qr</code></p>
<h3 id="check-its-all-working">Check it’s all working<a hidden class="anchor" aria-hidden="true" href="#check-its-all-working">#</a></h3>
<p>Firstly, in a Terminal, check the “last seen” entry by running the following:</p>
<p><code>sudo pivpn -c</code></p>
<p>Then, check the Pi-hole web interface under ‘<strong>Tools | Network</strong>‘ to see if the VPN gets filtered, there should be entries for:</p>
<pre tabindex="0"><code>Whatever_You_Want.pivpn
</code></pre><p>That’s how to install Pi-hole with Unbound and PiVPN.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://boffinsblog.github.io/tags/linux/">Linux</a></li>
      <li><a href="https://boffinsblog.github.io/tags/raspberry-pi/">Raspberry Pi</a></li>
      <li><a href="https://boffinsblog.github.io/tags/self-hosting/">Self Hosting</a></li>
      <li><a href="https://boffinsblog.github.io/tags/software/">Software</a></li>
      <li><a href="https://boffinsblog.github.io/tags/web-servers/">Web-Servers</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://boffinsblog.github.io/posts/installing-gitea/">
    <span class="title">« Prev</span>
    <br>
    <span>Installing Gitea</span>
  </a>
  <a class="next" href="https://boffinsblog.github.io/posts/rss-to-toot/">
    <span class="title">Next »</span>
    <br>
    <span>RSS to Toot</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://boffinsblog.github.io/">Boffins Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <br>
        <p><a href="https://www.creativecommons.org/licenses/by-nc/4.0/deed.en" rel="noopener noreferrer" target="_blank">This work is licensed under CC BY-NC-SA 4.0</a></p>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
