<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Firefish Backup and Restore | Boffins Blog</title>
<meta name="keywords" content="Bash, Fediverse, Linux, Raspberry Pi, Self Hosting, Web-Servers">
<meta name="description" content="Scripts and cron jobs to backup and restore the PostgreSQL database and Firefish files.">
<meta name="author" content="Boffin">
<link rel="canonical" href="https://boffinsblog.github.io/posts/firefish-backup-and-restore/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e13be8719bbabf4005d0d2b0f19dba897f7d41b2e807b64c47ee1436d126ab01.css" integrity="sha256-4TvocZu6v0AF0NKw8Z26iX99QbLoB7ZMR&#43;4UNtEmqwE=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://boffinsblog.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://boffinsblog.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://boffinsblog.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://boffinsblog.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://boffinsblog.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://boffinsblog.github.io/posts/firefish-backup-and-restore/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:url" content="https://boffinsblog.github.io/posts/firefish-backup-and-restore/">
  <meta property="og:site_name" content="Boffins Blog">
  <meta property="og:title" content="Firefish Backup and Restore">
  <meta property="og:description" content="Scripts and cron jobs to backup and restore the PostgreSQL database and Firefish files.">
  <meta property="og:locale" content="en-gb">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-07-22T15:03:57+01:00">
    <meta property="article:modified_time" content="2023-07-22T15:03:57+01:00">
    <meta property="article:tag" content="Bash">
    <meta property="article:tag" content="Fediverse">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Raspberry Pi">
    <meta property="article:tag" content="Self Hosting">
    <meta property="article:tag" content="Web-Servers">
    <meta property="og:image" content="https://boffinsblog.github.io/posts/firefish-backup-and-restore/01_Firefish_Script_Screenshot.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://boffinsblog.github.io/posts/firefish-backup-and-restore/01_Firefish_Script_Screenshot.webp">
<meta name="twitter:title" content="Firefish Backup and Restore">
<meta name="twitter:description" content="Scripts and cron jobs to backup and restore the PostgreSQL database and Firefish files.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://boffinsblog.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Firefish Backup and Restore",
      "item": "https://boffinsblog.github.io/posts/firefish-backup-and-restore/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Firefish Backup and Restore",
  "name": "Firefish Backup and Restore",
  "description": "Scripts and cron jobs to backup and restore the PostgreSQL database and Firefish files.",
  "keywords": [
    "Bash", "Fediverse", "Linux", "Raspberry Pi", "Self Hosting", "Web-Servers"
  ],
  "articleBody": "Still paranoid Within days of posting about how to backup and restore a Calckey server there was a rebrand and everything changed to Firefish; I’m still paranoid though, so I still need a Firefish backup and restore process.\nMake the directories on the server to send the Firefish backups to ssh into the server and:\nmkdir /home/foo/Backups/firefish\nmkdir /home/foo/Backups/firefish/files\nmkdir /home/foo/Backups/firefish/postgresql\nThe following method uses ‘pg_basebackup’ to take a full copy of the whole PostgreSQL database.\nThis process can be run whilst Firefish (or any other application using PostgreSQL) is running, so is ideal for scheduling with cron.\nI tried ‘pg_dump’ and ‘pg_restore’ for the single database but I couldn’t get it to restore properly.\nAlso:\nThe command ‘pg_basebackup’ needs a username / password for the command to run.\nFortunately, PostgreSQL has the ability to store this username / password combo in a file.\nThis is the .pgpass file.\nThe postgres user password may be already known but I found that in the Calckey / Firefish installation it wasn’t set, so to update or change the postgres user password:\nsudo su - postgres\npsql\nAt the postgres prompt type:\n\\password\nEnter new password twice.\nType:\n\\q\nTo quit.\n.pgpass The file .pgpass in a user’s home directory can contain passwords to be used if the connection requires a password\nhttps://www.postgresql.org/docs/current/libpq-pgpass.html Obviously the .pgpass file needs creating, and appropriate permissions granting.\nFirstly, create the .pgpass file:\nsudo nano /home/$USER/.pgpass\n#hostname:port:database:username:password :hostname:port:ThePostgresAccount:ThePostgresAccountPassword Then, own it:\nsudo chown $USER:$USER /home/$USER/.pgpass\nFinally, give the file the correct permissions:\nchmod 600 /home/$USER/.pgpass\nWrite it to the environment variables:\nexport PGPASSFILE='/home/$USER/.pgpass'\nCheck the environment variable using:\nenv\nThe ‘pg_basebackup’ command will now not ask for a password:\npg_basebackup -h localhost -p 5432 -U postgres_user -D /home/foo/Backups/firefish/postgresql -Fp -Xs -P\nBackup the Firefish database Firstly, create the database backup script:\nsudo nano /etc/init.d/backup_firefish_db.sh\nThen give the file the correct permissions:\nsudo chmod +x /etc/init.d/backup_firefish_db.sh\nbackup_firefish_db.sh #!/bin/bash # The remote backup process # ~~~~~~~~~~~~~~~~~~~~~~~~~ # Backup the whole of the PostgreSQL database rm -R /home/foo/Backups/firefish/postgresql/*; pg_basebackup -h localhost -p 5432 -U postgres -D /home/foo/Backups/firefish/postgresql -Fp -Xs -P; Backup the Firefish files directory The firefish /files/ directory holds all of the ‘Drive’ files.\n(All of those avatars, headers, wallpapers and meme collections.)\nFirstly, create the /files/ backup script:\nsudo nano /etc/init.d/backup_firefish_files.sh\nThen, give the file the correct permissions:\nsudo chmod +x /etc/init.d/backup_firefish_files.sh\nbackup_firefish_files.sh #!/bin/bash # The remote backup process # ~~~~~~~~~~~~~~~~~~~~~~~~~ # # Remove the file to show that a previous backup was created rm /home/foo/Backups/firefish_backup_created # # Backup the Firefish configs rm -r /home/foo/Backups/firefish/configs/* cp -r /home/firefish/firefish/.config/default.yml /home/foo/Backups/firefish/configs/ # # Backup the Firefish /files/ directory rm -r /home/foo/Backups/firefish/files/ cp -r /home/firefish/firefish/files /home/foo/Backups/firefish/files/ Because the /files/ directory is owned by the Firefish user it needs a sudo cron job.\nsudo crontab -e\n# # Backup the Firefish /files/ directory hourly 0 * * * * sh /etc/init.d/backup_firefish_files.sh # Archive the two backups Firstly, create the archive script:\nsudo nano /etc/init.d/backup_firefish_zipped.sh\nThen give the file the correct permissions:\nsudo chmod +x /etc/init.d/backup_firefish_zipped.sh\nbackup_firefish_zipped.sh #!/bin/bash # The remote backup process # ~~~~~~~~~~~~~~~~~~~~~~~~~ # # The backup the whole of the PostgreSQL database # is called by the user crontab '/etc/init.d/backup_firefish_db.sh' # # The backup of the Firefish 'default.yml' and the /files/ directory # is called by the sudo crontab '/etc/init.d/backup_firefish_files.sh' # # So call this in normal crontab after '/etc/init.d/backup_firefish_db.sh' rm /home/firefish/Backups/backup_firefish.zip; zip -r /home/foo/Backups/backup_firefish.zip /home/foo/Backups/firefish # # Create a file to show that the backup has successfully completed touch /home/foo/Backups/firefish_backup_created I backup the whole PostgreSQL and the /files/ database hourly using cron.\nThen I archive (zip) the whole lot.\ncrontab -e\n# # Backup the whole of the PostgreSQL database hourly # Then put the previous /files/ backup and this db backup into one zip 0 * * * * sh /etc/init.d/backup_firefish_db.sh; sh /etc/init.d/backup_firefish_zipped.sh # Firefish Restore Process Obviously there is no sense in keeping a server backup on the server where the original files are held.\nThat’s why there are two backups:\nA pair of folders on the server containing the database and the needed files\nA single zipped file that can be copied as part of a daily backup routine off the server\nThis way, I can easily restore from the hourly created server files and in the case of a yet-to-happen catastrophic event I can copy over the last locally held zip archive and restore from there.\nFirefish Script Screenshot\nI’m not going to cover how to get the zip archive on and off the server (hint: I use ssh keys and scp).\nThe following script executed server-side will restore (and give the correct permissions to) a Firefish PostgreSQL database and the /files/ directory.\nFirstly, create the restore script:\nsudo nano /etc/init.d/restore_firefish.sh\nThen, give the file the correct permissions:\nsudo chmod +x /etc/init.d/restore_firefish.sh\nrestore_firefish.sh #!/bin/bash # The remote restore process # ~~~~~~~~~~~~~~~~~~~~~~~~~~ # # Restore from the hourly backup on the server clear # Check to see if a backup has previously completed successfully # If a backup is in place then carry on and restore it if [ ! -f /home/foo/Backups/firefish_backup_created ]; then echo \"No previous backup to restore!\" exit 0 fi # Restore the Firefish 'default.yml' config echo -e \"\\e[1;33mRestore the Firefish 'default.yml' config...\\e[0m\" sudo cp /home/foo/Backups/firefish/configs/* /home/firefish/firefish/.config/ echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Restore the Firefish /files/ directory echo -e \"\\e[1;33mRestore the Firefish /files/ directory...\\e[0m\" sudo cp /home/foo/Backups/firefish/files/* /home/firefish/firefish/files echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Stop the running PostgreSQL service echo -e \"\\e[1;33mStop the running PostgreSQL service...\\e[0m\" sudo systemctl stop postgresql.service echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Current PostgreSQL status echo -e \"\\e[1;33mCurrent PostgreSQL status...\\e[0m\" sudo systemctl status postgresql echo -e \"\\e[32mDone\\e[0m\" echo \"\" # chown the existing PostgreSQL installation echo -e \"\\e[1;33mchown the existing PostgreSQL installation...\\e[0m\" sudo chown -R foo:foo /var/lib/postgresql/15/main/ echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Remove the existing PostgreSQL files echo -e \"\\e[1;33mRemove the existing PostgreSQL files...\\e[0m\" sudo rm -fr /var/lib/postgresql/15/main/* echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Copy the latest backup to the PostgreSQL target location echo -e \"\\e[1;33mCopy the latest backup to the PostgreSQL target location...\\e[0m\" sudo cp -R /home/foo/Backups/firefish/postgresql/* /var/lib/postgresql/15/main/ echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Make the PostgreSQL user take ownership of the target location echo -e \"\\e[1;33mMake the PostgreSQL user take ownership of the target location...\\e[0m\" sudo chown -R postgres:postgres /var/lib/postgresql/15/main/ echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Start the PostgreSQL service echo -e \"\\e[1;33mStart the PostgreSQL service...\\e[0m\" sudo systemctl start postgresql.service echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Current PostgreSQL status echo -e \"\\e[1;33mCurrent PostgreSQL status...\\e[0m\" sudo systemctl status postgresql echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Is Firefish running echo -e \"\\e[1;33mIs Firefish running...\\e[0m\" systemctl status --no-pager site.example.net.service echo -e \"\\e[32mDone\\e[0m\" echo \"\" However, rather than using the sh command, the script needs running using bash:\nbash /etc/init.d/firefish_restore.sh\nTo see the correctly coloured prompts.\nFinally (I did mention this in a prior post but it bears repeating.)\nFor anyone interested in getting into the SQL side, pgAdmin is a useful tool.\nI installed it using:\ncurl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg\nsudo sh -c 'echo \"deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/jammy pgadmin4 main\" \u003e /etc/apt/sources.list.d/pgadmin4.list \u0026\u0026 apt update'\nsudo apt update\nsudo apt install pgadmin4\npgAdmin Screenshot\nHowever you Fediverse, Enjoy!\nAll of the Firefish code examples can be found at , along with some SQL Snippets .\n",
  "wordCount" : "1210",
  "inLanguage": "en",
  "image":"https://boffinsblog.github.io/posts/firefish-backup-and-restore/01_Firefish_Script_Screenshot.webp","datePublished": "2023-07-22T15:03:57+01:00",
  "dateModified": "2023-07-22T15:03:57+01:00",
  "author":{
    "@type": "Person",
    "name": "Boffin"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://boffinsblog.github.io/posts/firefish-backup-and-restore/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Boffins Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://boffinsblog.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://boffinsblog.github.io/" accesskey="h" title="Boffins Blog (Alt + H)">Boffins Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://boffinsblog.github.io/categories/featured/" title="Featured">
                    <span>Featured</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://boffinsblog.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://boffinsblog.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Firefish Backup and Restore
    </h1>
    <div class="post-meta"><span title='2023-07-22 15:03:57 +0100 BST'>July 22, 2023</span>&nbsp;·&nbsp;<span>6 min</span>&nbsp;·&nbsp;<span>Boffin</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#still-paranoid" aria-label="Still paranoid">Still paranoid</a></li>
                <li>
                    <a href="#make-the-directories-on-the-server-to-send-the-firefish-backups-to" aria-label="Make the directories on the server to send the Firefish backups to">Make the directories on the server to send the Firefish backups to</a></li>
                <li>
                    <a href="#pgpass" aria-label=".pgpass">.pgpass</a></li>
                <li>
                    <a href="#backup-the-firefish-database" aria-label="Backup the Firefish database">Backup the Firefish database</a></li>
                <li>
                    <a href="#backup-the-firefish-files-directory" aria-label="Backup the Firefish files directory">Backup the Firefish files directory</a></li>
                <li>
                    <a href="#archive-the-two-backups" aria-label="Archive the two backups">Archive the two backups</a></li>
                <li>
                    <a href="#firefish-restore-process" aria-label="Firefish Restore Process">Firefish Restore Process</a></li>
                <li>
                    <a href="#finally" aria-label="Finally">Finally</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="still-paranoid">Still paranoid<a hidden class="anchor" aria-hidden="true" href="#still-paranoid">#</a></h2>
<p>Within days of posting about 


  <a href="/posts/calckey-fediverse-server/">how to backup and restore a Calckey server</a>
 there was a rebrand and everything changed to Firefish; I’m still paranoid though, so I still need a Firefish backup and restore process.</p>
<h2 id="make-the-directories-on-the-server-to-send-the-firefish-backups-to">Make the directories on the server to send the Firefish backups to<a hidden class="anchor" aria-hidden="true" href="#make-the-directories-on-the-server-to-send-the-firefish-backups-to">#</a></h2>
<p><code>ssh</code> into the server and:</p>
<p><code>mkdir /home/foo/Backups/firefish</code></p>
<p><code>mkdir /home/foo/Backups/firefish/files</code></p>
<p><code>mkdir /home/foo/Backups/firefish/postgresql</code></p>
<p>The following method uses <em>‘pg_basebackup’</em> to take a full copy of the whole PostgreSQL database.</p>
<p>This process can be run whilst Firefish (or any other application using PostgreSQL) is running, so is ideal for scheduling with <code>cron</code>.</p>
<p>I tried <em>‘pg_dump’</em> and <em>‘pg_restore’</em> for the single database but I couldn’t get it to restore properly.</p>
<p>Also:</p>
<p>The command <em>‘pg_basebackup’</em> needs a username / password for the command to run.</p>
<p>Fortunately, PostgreSQL has the ability to store this username / password combo in a file.</p>
<p>This is the .pgpass file.</p>
<p>The postgres user password may be already known but I found that in the Calckey / Firefish installation it wasn’t set, so to update or change the postgres user password:</p>
<p><code>sudo su - postgres</code></p>
<p><code>psql</code></p>
<p>At the postgres prompt type:</p>
<p><code>\password</code></p>
<p>Enter new password twice.</p>
<p>Type:</p>
<p><code>\q</code></p>
<p>To quit.</p>
<h2 id="pgpass">.pgpass<a hidden class="anchor" aria-hidden="true" href="#pgpass">#</a></h2>
<blockquote>
<p>The file .pgpass in a user’s home directory can contain passwords to be used if the connection requires a password</p>
<p><em>

<a href="https://www.postgresql.org/docs/current/libpq-pgpass.html" target="_blank" rel="nofollow noopener noreferrer">https://www.postgresql.org/docs/current/libpq-pgpass.html</a>
</em></p></blockquote>
<p>Obviously the .pgpass file needs creating, and appropriate permissions granting.</p>
<p>Firstly, create the .pgpass file:</p>
<p><code>sudo nano /home/$USER/.pgpass</code></p>
<pre tabindex="0"><code>#hostname:port:database:username:password
:hostname:port:ThePostgresAccount:ThePostgresAccountPassword
</code></pre><p>Then, own it:</p>
<p><code>sudo chown $USER:$USER /home/$USER/.pgpass</code></p>
<p>Finally, give the file the correct permissions:</p>
<p><code>chmod 600 /home/$USER/.pgpass</code></p>
<p>Write it to the environment variables:</p>
<p><code>export PGPASSFILE='/home/$USER/.pgpass'</code></p>
<p>Check the environment variable using:</p>
<p><code>env</code></p>
<p>The <em>‘pg_basebackup’</em> command will now not ask for a password:</p>
<p><code>pg_basebackup -h localhost -p 5432 -U postgres_user -D /home/foo/Backups/firefish/postgresql -Fp -Xs -P</code></p>
<h2 id="backup-the-firefish-database">Backup the Firefish database<a hidden class="anchor" aria-hidden="true" href="#backup-the-firefish-database">#</a></h2>
<p>Firstly, create the database backup script:</p>
<p><code>sudo nano /etc/init.d/backup_firefish_db.sh</code></p>
<p>Then give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/backup_firefish_db.sh</code></p>
<h3 id="backup_">

<a href="https://github.com/BoffinsBlog/Firefish/blob/main/backup/backup_firefish_db.sh" target="_blank" rel="nofollow noopener noreferrer">backup_firefish_db.sh</a>
</h3>
<pre tabindex="0"><code>#!/bin/bash

# The remote backup process
# ~~~~~~~~~~~~~~~~~~~~~~~~~
# Backup the whole of the PostgreSQL database
rm -R /home/foo/Backups/firefish/postgresql/*;
pg_basebackup -h localhost -p 5432 -U postgres -D /home/foo/Backups/firefish/postgresql -Fp -Xs -P;
</code></pre><h2 id="backup-the-firefish-files-directory">Backup the Firefish files directory<a hidden class="anchor" aria-hidden="true" href="#backup-the-firefish-files-directory">#</a></h2>
<p>The firefish /files/ directory holds all of the ‘Drive’ files.</p>
<p>(All of those avatars, headers, wallpapers and meme collections.)</p>
<p>Firstly, create the /files/ backup script:</p>
<p><code>sudo nano /etc/init.d/backup_firefish_files.sh</code></p>
<p>Then, give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/backup_firefish_files.sh</code></p>
<h3 id="backup_-1">

<a href="https://github.com/BoffinsBlog/Firefish/blob/main/backup/backup_firefish_files.sh" target="_blank" rel="nofollow noopener noreferrer">backup_firefish_files.sh</a>
</h3>
<pre tabindex="0"><code>#!/bin/bash

# The remote backup process
# ~~~~~~~~~~~~~~~~~~~~~~~~~
#
# Remove the file to show that a previous backup was created
rm /home/foo/Backups/firefish_backup_created
#
# Backup the Firefish configs
rm -r /home/foo/Backups/firefish/configs/*
cp -r /home/firefish/firefish/.config/default.yml /home/foo/Backups/firefish/configs/
#
# Backup the Firefish /files/ directory
rm -r /home/foo/Backups/firefish/files/
cp -r /home/firefish/firefish/files /home/foo/Backups/firefish/files/
</code></pre><p>Because the /files/ directory is owned by the Firefish user it needs a <code>sudo</code> cron job.</p>
<p><code>sudo crontab -e</code></p>
<pre tabindex="0"><code>#
# Backup the Firefish /files/ directory hourly
0 * * * * sh /etc/init.d/backup_firefish_files.sh
#
</code></pre><h2 id="archive-the-two-backups">Archive the two backups<a hidden class="anchor" aria-hidden="true" href="#archive-the-two-backups">#</a></h2>
<p>Firstly, create the archive script:</p>
<p><code>sudo nano /etc/init.d/backup_firefish_zipped.sh</code></p>
<p>Then give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/backup_firefish_zipped.sh</code></p>
<h3 id="backup_-2">

<a href="https://github.com/BoffinsBlog/Firefish/blob/main/backup/backup_firefish_zipped.sh" target="_blank" rel="nofollow noopener noreferrer">backup_firefish_zipped.sh</a>
</h3>
<pre tabindex="0"><code>#!/bin/bash

# The remote backup process
# ~~~~~~~~~~~~~~~~~~~~~~~~~
#
# The backup the whole of the PostgreSQL database
# is called by the user crontab &#39;/etc/init.d/backup_firefish_db.sh&#39;
#
# The backup of the Firefish &#39;default.yml&#39; and the /files/ directory
# is called by the sudo crontab &#39;/etc/init.d/backup_firefish_files.sh&#39;
#
#  So call this in normal crontab after &#39;/etc/init.d/backup_firefish_db.sh&#39;
rm /home/firefish/Backups/backup_firefish.zip;
zip -r /home/foo/Backups/backup_firefish.zip /home/foo/Backups/firefish
#
# Create a file to show that the backup has successfully completed
touch /home/foo/Backups/firefish_backup_created
</code></pre><p>I backup the whole PostgreSQL and the /files/ database hourly using cron.</p>
<p>Then I archive (zip) the whole lot.</p>
<p><code>crontab -e</code></p>
<pre tabindex="0"><code>#
# Backup the whole of the PostgreSQL database hourly
# Then put the previous /files/ backup and this db backup into one zip
0 * * * * sh /etc/init.d/backup_firefish_db.sh; sh /etc/init.d/backup_firefish_zipped.sh
#
</code></pre><h2 id="firefish-restore-process">Firefish Restore Process<a hidden class="anchor" aria-hidden="true" href="#firefish-restore-process">#</a></h2>
<p>Obviously there is no sense in keeping a server backup on the server where the original files are held.</p>
<p>That’s why there are <strong>two</strong> backups:</p>
<ul>
<li>
<p>A pair of folders <em><strong>on</strong></em> the server containing the database and the needed files</p>
</li>
<li>
<p>A single zipped file that can be copied as part of a daily backup routine <em><strong>off</strong></em> the server</p>
</li>
</ul>
<p>This way, I can easily restore from the hourly created server files and in the case of a yet-to-happen catastrophic event I can copy over the last locally held zip archive and restore from there.</p>
<p><img alt="A screenshot showing some of the Firefish backup and restore script in an editor." loading="lazy" src="/posts/firefish-backup-and-restore/01_Firefish_Script_Screenshot.webp#center">
<em>Firefish Script Screenshot</em></p>
<p>I’m not going to cover how to get the zip archive <em><strong>on</strong></em> and <em><strong>off</strong></em> the server (hint: I use <code>ssh</code> keys and <code>scp</code>).</p>
<p>The following script executed server-side will restore (and give the correct permissions to) a Firefish PostgreSQL database and the /files/ directory.</p>
<p>Firstly, create the restore script:</p>
<p><code>sudo nano /etc/init.d/restore_firefish.sh</code></p>
<p>Then, give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/restore_firefish.sh</code></p>
<h3 id="restore_">

<a href="https://github.com/BoffinsBlog/Firefish/blob/main/restore/restore_firefish.sh" target="_blank" rel="nofollow noopener noreferrer">restore_firefish.sh</a>
</h3>
<pre tabindex="0"><code>#!/bin/bash

# The remote restore process
# ~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# Restore from the hourly backup on the server

clear

# Check to see if a backup has previously completed successfully
# If a backup is in place then carry on and restore it
if [ ! -f /home/foo/Backups/firefish_backup_created ]; then
    echo &#34;No previous backup to restore!&#34;
    exit 0
fi

# Restore the Firefish &#39;default.yml&#39; config
echo -e &#34;\e[1;33mRestore the Firefish &#39;default.yml&#39; config...\e[0m&#34;
sudo cp /home/foo/Backups/firefish/configs/* /home/firefish/firefish/.config/
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Restore the Firefish /files/ directory
echo -e &#34;\e[1;33mRestore the Firefish /files/ directory...\e[0m&#34;
sudo cp /home/foo/Backups/firefish/files/* /home/firefish/firefish/files
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Stop the running PostgreSQL service
echo -e &#34;\e[1;33mStop the running PostgreSQL service...\e[0m&#34;
sudo systemctl stop postgresql.service
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Current PostgreSQL status
echo -e &#34;\e[1;33mCurrent PostgreSQL status...\e[0m&#34;
sudo systemctl status postgresql
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# chown the existing PostgreSQL installation
echo -e &#34;\e[1;33mchown the existing PostgreSQL installation...\e[0m&#34;
sudo chown -R foo:foo /var/lib/postgresql/15/main/
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Remove the existing PostgreSQL files
echo -e &#34;\e[1;33mRemove the existing PostgreSQL files...\e[0m&#34;
sudo rm -fr /var/lib/postgresql/15/main/*
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Copy the latest backup to the PostgreSQL target location
echo -e &#34;\e[1;33mCopy the latest backup to the PostgreSQL target location...\e[0m&#34;
sudo cp -R /home/foo/Backups/firefish/postgresql/* /var/lib/postgresql/15/main/
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Make the PostgreSQL user take ownership of the target location
echo -e &#34;\e[1;33mMake the PostgreSQL user take ownership of the target location...\e[0m&#34;
sudo chown -R postgres:postgres /var/lib/postgresql/15/main/
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Start the PostgreSQL service
echo -e &#34;\e[1;33mStart the PostgreSQL service...\e[0m&#34;
sudo systemctl start postgresql.service
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Current PostgreSQL status
echo -e &#34;\e[1;33mCurrent PostgreSQL status...\e[0m&#34;
sudo systemctl status postgresql
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Is Firefish running
echo -e &#34;\e[1;33mIs Firefish running...\e[0m&#34;
systemctl status --no-pager site.example.net.service
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;
</code></pre><p>However, rather than using the <code>sh</code> command, the script needs running using <code>bash</code>:</p>
<p><code>bash /etc/init.d/firefish_restore.sh</code></p>
<p>To see the correctly coloured prompts.</p>
<h2 id="finally">Finally<a hidden class="anchor" aria-hidden="true" href="#finally">#</a></h2>
<p>(I did mention this in a 


  <a href="/posts/calckey-fediverse-server/">prior post</a>
 but it bears repeating.)</p>
<p>For anyone interested in getting into the SQL side, pgAdmin is a useful tool.</p>
<p>I installed it using:</p>
<p><code>curl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg</code></p>
<p><code>sudo sh -c 'echo &quot;deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/jammy pgadmin4 main&quot; &gt; /etc/apt/sources.list.d/pgadmin4.list &amp;&amp; apt update'</code></p>
<p><code>sudo apt update</code></p>
<p><code>sudo apt install pgadmin4</code></p>
<p><img alt="A screenshot of the Linux application pgAdmin, used to administer PostgreSQL databases. The Calckey Fediverse Server uses PostgreSQL as its back end database engine." loading="lazy" src="/posts/firefish-backup-and-restore/01_pgAdmin_Screenshot.webp#center" title="A screenshot of the Linux application pgAdmin, used to administer PostgreSQL databases. The Calckey Fediverse Server uses PostgreSQL as its back end database engine.">
<em>pgAdmin Screenshot</em></p>
<p>However you Fediverse, Enjoy!</p>
<p>All of the Firefish code examples can be found 

<a href="https://github.com/BoffinsBlog/Firefish/" target="_blank" rel="nofollow noopener noreferrer">at</a>
, along with some 

<a href="https://github.com/BoffinsBlog/Firefish/tree/main/sql/" target="_blank" rel="nofollow noopener noreferrer">SQL Snippets</a>
.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://boffinsblog.github.io/tags/bash/">Bash</a></li>
      <li><a href="https://boffinsblog.github.io/tags/fediverse/">Fediverse</a></li>
      <li><a href="https://boffinsblog.github.io/tags/linux/">Linux</a></li>
      <li><a href="https://boffinsblog.github.io/tags/raspberry-pi/">Raspberry Pi</a></li>
      <li><a href="https://boffinsblog.github.io/tags/self-hosting/">Self Hosting</a></li>
      <li><a href="https://boffinsblog.github.io/tags/web-servers/">Web-Servers</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://boffinsblog.github.io/posts/installing-iceshrimp/">
    <span class="title">« Prev</span>
    <br>
    <span>Installing Iceshrimp</span>
  </a>
  <a class="next" href="https://boffinsblog.github.io/posts/calckey-fediverse-server/">
    <span class="title">Next »</span>
    <br>
    <span>Calckey Fediverse Server</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://boffinsblog.github.io/">Boffins Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <br>
        <p><a href="https://www.creativecommons.org/licenses/by-nc/4.0/deed.en" rel="noopener noreferrer" target="_blank">This work is licensed under CC BY-NC-SA 4.0</a></p>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
