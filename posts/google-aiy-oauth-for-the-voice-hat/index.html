<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Google AIY OAuth for the Voice Hat | Boffins Blog</title>
<meta name="keywords" content="Google AIY, Hardware, Raspberry Pi, Software">
<meta name="description" content="Finally got my Google AIY box talking again.">
<meta name="author" content="Boffin">
<link rel="canonical" href="https://boffinsblog.github.io/posts/google-aiy-oauth-for-the-voice-hat/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e13be8719bbabf4005d0d2b0f19dba897f7d41b2e807b64c47ee1436d126ab01.css" integrity="sha256-4TvocZu6v0AF0NKw8Z26iX99QbLoB7ZMR&#43;4UNtEmqwE=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://boffinsblog.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://boffinsblog.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://boffinsblog.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://boffinsblog.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://boffinsblog.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://boffinsblog.github.io/posts/google-aiy-oauth-for-the-voice-hat/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:url" content="https://boffinsblog.github.io/posts/google-aiy-oauth-for-the-voice-hat/">
  <meta property="og:site_name" content="Boffins Blog">
  <meta property="og:title" content="Google AIY OAuth for the Voice Hat">
  <meta property="og:description" content="Finally got my Google AIY box talking again.">
  <meta property="og:locale" content="en-gb">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-06-13T23:19:28+01:00">
    <meta property="article:modified_time" content="2025-06-13T23:19:28+01:00">
    <meta property="article:tag" content="Google AIY">
    <meta property="article:tag" content="Hardware">
    <meta property="article:tag" content="Raspberry Pi">
    <meta property="article:tag" content="Software">
    <meta property="og:image" content="https://boffinsblog.github.io/posts/google-aiy-oauth-for-the-voice-hat/01_Google_OAuth_PHP_Code.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://boffinsblog.github.io/posts/google-aiy-oauth-for-the-voice-hat/01_Google_OAuth_PHP_Code.webp">
<meta name="twitter:title" content="Google AIY OAuth for the Voice Hat">
<meta name="twitter:description" content="Finally got my Google AIY box talking again.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://boffinsblog.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Google AIY OAuth for the Voice Hat",
      "item": "https://boffinsblog.github.io/posts/google-aiy-oauth-for-the-voice-hat/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Google AIY OAuth for the Voice Hat",
  "name": "Google AIY OAuth for the Voice Hat",
  "description": "Finally got my Google AIY box talking again.",
  "keywords": [
    "Google AIY", "Hardware", "Raspberry Pi", "Software"
  ],
  "articleBody": "My AIY box stopped working.\nGoogle stopped talking to me.\nFor a short while I could regenerate a temporary token but the token lasted a mere seven days.\nSo, inevitably, when I shouted at the box to set a timer or something equally trivial, it didn’t respond.\nRegularly resetting the token was a faff and frequently forgotten, so the box fell into disuse.\nGetting the box running properly again was added to my list of things to do.\nThe Past Back in the distant past authorising Google AIY was a simple-ish process:\nGo to the Google cloud console\nCreate a Project\nEnable the Google Assistant API\nCreate some API credentials\nDownload a JSON file and save it to the Pi as assistant.json\nLaunch the python aiy script in a Terminal on the Pi (and wait)\nThe Terminal will prompt visiting a URL\nGo to the URL, agree and wait for the Authorisation response code\nPaste said code in the waiting Terminal\nGo through the Authorisation acceptance steps\n(OK, not that simple but a fairly straightforward set of steps.)\nThe above process is known as OOB or ‘Out of Band’ .\nIt has been deprecated in favour of a more secure OAuth flow.\n(I think it has something to do with an access token being part of the response URL but I could be wrong about that.)\nThe Present Google has stopped using OOB completely (even temporary tokens are unavailable) and they now enforce OAuth.\nThe authorisation process is similar but somewhat more involved:\nGo to the Google cloud console\nCreate a Project\nAdd tld.domain to ‘Branding | Authorised domains’ Enable the Google Assistant API\nCreate some API credentials:\nIn Clients\nCreate Client (Create OAuth client ID)\nApplication Type: Desktop app\nName: SomeName\nClick ‘Create’\nCopy the Client ID from the pop-up dialogue\nCopy the Client Secret from the pop-up dialogue\nDownload a JSON file and save it to the Pi as assistant.json\nCreate a tld.domain/auth folder on a web server\nCreate a tld.domain/auth/index.php file from the OAuth code below\nCopy:\nClient ID\nClient Secret\nInto tld.domain/auth/index.php\nLaunch the python aiy script in a Terminal on the Pi (and wait)\nThe Terminal will prompt visiting a URL\nGo to the URL, agree and wait for the Authorisation response code\nPaste said code in the waiting Terminal\nGo through the Authorisation acceptance steps\nThe Code As I was reading about how to configure OAuth I came across this site .\nThe whole site is well worth a read as it gives an in depth overview of how OAuth works.\nEmbedded within that site is a link to this repo .\nThe following code is a direct copy of the Google OAuth example from the that repo and is duplicated here for posterity purposes.\nGoogle OAuth \u003c?php // Fill these out with the values you got from Google $googleClientID = ''; $googleClientSecret = ''; // This is the URL we'll send the user to first to get their authorization $authorizationEndpoint = 'https://accounts.google.com/o/oauth2/v2/auth'; // This is Google's OpenID Connect token endpoint $tokenEndpoint = 'https://www.googleapis.com/oauth2/v4/token'; // The URL for this script, used as the redirect URL // If PHP isn't setting these right you can put the full URL here manually $protocol = isset($_SERVER['HTTPS']) \u0026\u0026 $_SERVER['HTTPS'] === 'on' ? 'https' : 'http'; $redirectURL = $protocol . '://' . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF']; // Start a session so we have a place to store things between redirects session_start(); // Start the login process by sending the user // to Google's authorization page if(isset($_GET['action']) \u0026\u0026 $_GET['action'] == 'login') { unset($_SESSION['user_id']); // Generate a random hash and store in the session $_SESSION['state'] = bin2hex(random_bytes(16)); $params = array( 'response_type' =\u003e 'code', 'client_id' =\u003e $googleClientID, 'redirect_uri' =\u003e $redirectURL, 'scope' =\u003e 'openid email', 'state' =\u003e $_SESSION['state'] ); // Redirect the user to Google's authorization page header('Location: ' . $authorizationEndpoint . '?' . http_build_query($params)); die(); } if(isset($_GET['action']) \u0026\u0026 $_GET['action'] == 'logout') { unset($_SESSION['user_id']); header('Location: '.$redirectURL); die(); } // When Google redirects the user back here, there will be a \"code\" and \"state\" // parameter in the query string if(isset($_GET['code'])) { // Verify the state matches our stored state if(!isset($_GET['state']) || $_SESSION['state'] != $_GET['state']) { header('Location: ' . $redirectURL . '?error=invalid_state'); die(); } // Exchange the auth code for a token $ch = curl_init($tokenEndpoint); curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([ 'grant_type' =\u003e 'authorization_code', 'client_id' =\u003e $googleClientID, 'client_secret' =\u003e $googleClientSecret, 'redirect_uri' =\u003e $redirectURL, 'code' =\u003e $_GET['code'] ])); $response = curl_exec($ch); $data = json_decode($response, true); // Note: You'd probably want to use a real JWT library // but this will do in a pinch. This is only safe to do // because the ID token came from the https connection // from Google rather than an untrusted browser redirect // Split the JWT string into three parts $jwt = explode('.', $data['id_token']); // Extract the middle part, base64 decode it, then json_decode it $userinfo = json_decode(base64_decode($jwt[1]), true); $_SESSION['user_id'] = $userinfo['sub']; $_SESSION['email'] = $userinfo['email']; // While we're at it, let's store the access token and id token // so we can use them later $_SESSION['access_token'] = $data['access_token']; $_SESSION['id_token'] = $data['id_token']; $_SESSION['userinfo'] = $userinfo; header('Location: ' . $redirectURL); die(); } // If there is a user ID in the session // the user is already logged in if(!isset($_GET['action'])) { if(!empty($_SESSION['user_id'])) { echo 'Logged In'; echo 'User ID: '.$_SESSION['user_id'].'\n'; echo 'Email: '.$_SESSION['email'].'\n'; echo 'Log Out\n'; echo 'ID Token'; echo ''; print_r($_SESSION['userinfo']); echo ''; echo 'User Info'; echo ''; $ch = curl_init('https://www.googleapis.com/oauth2/v3/userinfo'); curl_setopt($ch, CURLOPT_HTTPHEADER, [ 'Authorization: Bearer '.$_SESSION['access_token'] ]); curl_exec($ch); echo ''; } else { echo 'Not logged in'; echo 'Log In\n'; } die(); } Yes, it’s more complicated.\nYes, there are more steps.\nBut my Google box is back to shouting at me again.\nThe Future Google are known for changing stuff.\nI’m sure this authorisation process will change too.\nFinally You might also like to read an illustrated guide to OAuth , though by now you are probably fed up with the whole thing.\n",
  "wordCount" : "987",
  "inLanguage": "en",
  "image":"https://boffinsblog.github.io/posts/google-aiy-oauth-for-the-voice-hat/01_Google_OAuth_PHP_Code.webp","datePublished": "2025-06-13T23:19:28+01:00",
  "dateModified": "2025-06-13T23:19:28+01:00",
  "author":{
    "@type": "Person",
    "name": "Boffin"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://boffinsblog.github.io/posts/google-aiy-oauth-for-the-voice-hat/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Boffins Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://boffinsblog.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://boffinsblog.github.io/" accesskey="h" title="Boffins Blog (Alt + H)">Boffins Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://boffinsblog.github.io/categories/featured/" title="Featured">
                    <span>Featured</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://boffinsblog.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://boffinsblog.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Google AIY OAuth for the Voice Hat
    </h1>
    <div class="post-meta"><span title='2025-06-13 23:19:28 +0100 BST'>June 13, 2025</span>&nbsp;·&nbsp;<span>5 min</span>&nbsp;·&nbsp;<span>Boffin</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#the-past" aria-label="The Past">The Past</a></li>
                <li>
                    <a href="#the-present" aria-label="The Present">The Present</a></li>
                <li>
                    <a href="#the-code" aria-label="The Code">The Code</a></li>
                <li>
                    <a href="#the-future" aria-label="The Future">The Future</a></li>
                <li>
                    <a href="#finally" aria-label="Finally">Finally</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>My 


  <a href="/posts/google-aiy-a-raspberrypi-and-a-scroll-phat/">AIY box</a>
 stopped working.</p>
<p>Google stopped talking to me.</p>
<p>For a short while I could regenerate a temporary token but the token lasted a mere seven days.</p>
<p>So, inevitably, when I shouted at the box to set a timer or something equally trivial, it didn&rsquo;t respond.</p>
<p>Regularly resetting the token was a faff and frequently forgotten, so the box fell into disuse.</p>
<p>Getting the box running properly again was added to my list of things to do.</p>
<h2 id="the-past">The Past<a hidden class="anchor" aria-hidden="true" href="#the-past">#</a></h2>
<p>Back in the distant past authorising Google AIY was a simple-ish process:</p>
<ul>
<li>
<p>Go to the Google cloud console</p>
</li>
<li>
<p>Create a Project</p>
</li>
<li>
<p>Enable the Google Assistant API</p>
</li>
<li>
<p>Create some API credentials</p>
</li>
<li>
<p>Download a JSON file and save it to the Pi as <code>assistant.json</code></p>
</li>
<li>
<p>Launch the python <code>aiy</code> script in a Terminal on the Pi (and wait)</p>
</li>
<li>
<p>The Terminal will prompt visiting a URL</p>
</li>
<li>
<p>Go to the URL, agree and wait for the Authorisation response code</p>
</li>
<li>
<p>Paste said code in the waiting Terminal</p>
</li>
<li>
<p>Go through the Authorisation acceptance steps</p>
</li>
</ul>
<p>(OK, not that simple but a fairly straightforward set of steps.)</p>
<p>The above process is known as 

<a href="https://developers.google.com/identity/protocols/oauth2/resources/oob-migration#what-is-oob" target="_blank" rel="nofollow noopener noreferrer">OOB or &lsquo;Out of Band&rsquo;</a>
.</p>
<p>It has been deprecated in favour of a more secure OAuth flow.</p>
<p>(I <em>think</em> it has something to do with an access token being part of the response URL but I could be wrong about that.)</p>
<h2 id="the-present">The Present<a hidden class="anchor" aria-hidden="true" href="#the-present">#</a></h2>
<p>Google has stopped using OOB completely (even temporary tokens are unavailable) and they now enforce OAuth.</p>
<p>The authorisation process is similar but somewhat more involved:</p>
<ul>
<li>
<p>Go to the Google cloud console</p>
</li>
<li>
<p>Create a Project</p>
<ul>
<li>Add <code>tld.domain</code> to &lsquo;Branding | Authorised domains&rsquo;</li>
</ul>
</li>
<li>
<p>Enable the Google Assistant API</p>
</li>
<li>
<p>Create some API credentials:</p>
</li>
<li>
<p>In Clients</p>
<ul>
<li>
<p>Create Client (Create OAuth client ID)</p>
</li>
<li>
<p>Application Type: Desktop app</p>
</li>
<li>
<p>Name: SomeName</p>
</li>
<li>
<p>Click &lsquo;Create&rsquo;</p>
</li>
</ul>
</li>
<li>
<p>Copy the Client ID from the pop-up dialogue</p>
</li>
<li>
<p>Copy the Client Secret from the pop-up dialogue</p>
</li>
<li>
<p>Download a JSON file and save it to the Pi as <code>assistant.json</code></p>
</li>
<li>
<p>Create a <code>tld.domain/auth</code> folder on a web server</p>
</li>
<li>
<p>Create a <code>tld.domain/auth/index.php</code> file from the OAuth code below</p>
</li>
<li>
<p>Copy:</p>
<ul>
<li>
<p>Client ID</p>
</li>
<li>
<p>Client Secret</p>
</li>
</ul>
</li>
<li>
<p>Into <code>tld.domain/auth/index.php</code></p>
</li>
<li>
<p>Launch the python <code>aiy</code> script in a Terminal on the Pi (and wait)</p>
</li>
<li>
<p>The Terminal will prompt visiting a URL</p>
</li>
<li>
<p>Go to the URL, agree and wait for the Authorisation response code</p>
</li>
<li>
<p>Paste said code in the waiting Terminal</p>
</li>
<li>
<p>Go through the Authorisation acceptance steps</p>
</li>
</ul>
<h2 id="the-code">The Code<a hidden class="anchor" aria-hidden="true" href="#the-code">#</a></h2>
<p>As I was reading about how to configure OAuth I came across 

<a href="https://www.oauth.com/oauth2-servers/getting-ready/" target="_blank" rel="nofollow noopener noreferrer">this site</a>
.</p>
<p>The whole site is well worth a read as it gives an in depth overview of how OAuth works.</p>
<p>Embedded within that site is a link to 

<a href="https://github.com/aaronpk/sample-oauth2-client" target="_blank" rel="nofollow noopener noreferrer">this repo</a>
.</p>
<p>The following code is a direct copy of the 

<a href="https://github.com/aaronpk/sample-oauth2-client/blob/master/google.php" target="_blank" rel="nofollow noopener noreferrer">Google OAuth example</a>
 from the that repo and is duplicated here for posterity purposes.</p>
<h3 id="google-oauth">

<a href="https://github.com/BoffinsBlog/Voice-HAT/blob/main/OAuth/google_oauth.php" target="_blank" rel="nofollow noopener noreferrer">Google OAuth</a>
</h3>
<pre tabindex="0"><code>&lt;?php
// Fill these out with the values you got from Google
$googleClientID = &#39;&#39;;
$googleClientSecret = &#39;&#39;;

// This is the URL we&#39;ll send the user to first to get their authorization
$authorizationEndpoint = &#39;https://accounts.google.com/o/oauth2/v2/auth&#39;;

// This is Google&#39;s OpenID Connect token endpoint
$tokenEndpoint = &#39;https://www.googleapis.com/oauth2/v4/token&#39;;

// The URL for this script, used as the redirect URL
// If PHP isn&#39;t setting these right you can put the full URL here manually
$protocol = isset($_SERVER[&#39;HTTPS&#39;]) &amp;&amp; $_SERVER[&#39;HTTPS&#39;] === &#39;on&#39; ? &#39;https&#39; : &#39;http&#39;;
$redirectURL = $protocol . &#39;://&#39; . $_SERVER[&#39;HTTP_HOST&#39;] . $_SERVER[&#39;PHP_SELF&#39;];

// Start a session so we have a place to store things between redirects
session_start();



// Start the login process by sending the user
// to Google&#39;s authorization page
if(isset($_GET[&#39;action&#39;]) &amp;&amp; $_GET[&#39;action&#39;] == &#39;login&#39;) {
  unset($_SESSION[&#39;user_id&#39;]);

  // Generate a random hash and store in the session
  $_SESSION[&#39;state&#39;] = bin2hex(random_bytes(16));

  $params = array(
    &#39;response_type&#39; =&gt; &#39;code&#39;,
    &#39;client_id&#39; =&gt; $googleClientID,
    &#39;redirect_uri&#39; =&gt; $redirectURL,
    &#39;scope&#39; =&gt; &#39;openid email&#39;,
    &#39;state&#39; =&gt; $_SESSION[&#39;state&#39;]
  );

  // Redirect the user to Google&#39;s authorization page
  header(&#39;Location: &#39; . $authorizationEndpoint . &#39;?&#39; . http_build_query($params));
  die();
}

if(isset($_GET[&#39;action&#39;]) &amp;&amp; $_GET[&#39;action&#39;] == &#39;logout&#39;) {
  unset($_SESSION[&#39;user_id&#39;]);
  header(&#39;Location: &#39;.$redirectURL);
  die();
}

// When Google redirects the user back here, there will be a &#34;code&#34; and &#34;state&#34;
// parameter in the query string
if(isset($_GET[&#39;code&#39;])) {
  // Verify the state matches our stored state
  if(!isset($_GET[&#39;state&#39;]) || $_SESSION[&#39;state&#39;] != $_GET[&#39;state&#39;]) {
    header(&#39;Location: &#39; . $redirectURL . &#39;?error=invalid_state&#39;);
    die();
  }

  // Exchange the auth code for a token
  $ch = curl_init($tokenEndpoint);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
  curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
    &#39;grant_type&#39; =&gt; &#39;authorization_code&#39;,
    &#39;client_id&#39; =&gt; $googleClientID,
    &#39;client_secret&#39; =&gt; $googleClientSecret,
    &#39;redirect_uri&#39; =&gt; $redirectURL,
    &#39;code&#39; =&gt; $_GET[&#39;code&#39;]
  ]));
  $response = curl_exec($ch);
  $data = json_decode($response, true);

  // Note: You&#39;d probably want to use a real JWT library
  // but this will do in a pinch. This is only safe to do
  // because the ID token came from the https connection
  // from Google rather than an untrusted browser redirect

  // Split the JWT string into three parts
  $jwt = explode(&#39;.&#39;, $data[&#39;id_token&#39;]);

  // Extract the middle part, base64 decode it, then json_decode it
  $userinfo = json_decode(base64_decode($jwt[1]), true);

  $_SESSION[&#39;user_id&#39;] = $userinfo[&#39;sub&#39;];
  $_SESSION[&#39;email&#39;] = $userinfo[&#39;email&#39;];

  // While we&#39;re at it, let&#39;s store the access token and id token
  // so we can use them later
  $_SESSION[&#39;access_token&#39;] = $data[&#39;access_token&#39;];
  $_SESSION[&#39;id_token&#39;] = $data[&#39;id_token&#39;];
  $_SESSION[&#39;userinfo&#39;] = $userinfo;

  header(&#39;Location: &#39; . $redirectURL);
  die();
}



// If there is a user ID in the session
// the user is already logged in
if(!isset($_GET[&#39;action&#39;])) {
  if(!empty($_SESSION[&#39;user_id&#39;])) {
    echo &#39;&lt;h3&gt;Logged In&lt;/h3&gt;&#39;;
    echo &#39;&lt;p&gt;User ID: &#39;.$_SESSION[&#39;user_id&#39;].&#39;&lt;/p&gt;&#39;;
    echo &#39;&lt;p&gt;Email: &#39;.$_SESSION[&#39;email&#39;].&#39;&lt;/p&gt;&#39;;
    echo &#39;&lt;p&gt;&lt;a href=&#34;?action=logout&#34;&gt;Log Out&lt;/a&gt;&lt;/p&gt;&#39;;

    echo &#39;&lt;h3&gt;ID Token&lt;/h3&gt;&#39;;
    echo &#39;&lt;pre&gt;&#39;;
    print_r($_SESSION[&#39;userinfo&#39;]);
    echo &#39;&lt;/pre&gt;&#39;;

    echo &#39;&lt;h3&gt;User Info&lt;/h3&gt;&#39;;
    echo &#39;&lt;pre&gt;&#39;;
    $ch = curl_init(&#39;https://www.googleapis.com/oauth2/v3/userinfo&#39;);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
      &#39;Authorization: Bearer &#39;.$_SESSION[&#39;access_token&#39;]
    ]);
    curl_exec($ch);
    echo &#39;&lt;/pre&gt;&#39;;

  } else {
    echo &#39;&lt;h3&gt;Not logged in&lt;/h3&gt;&#39;;
    echo &#39;&lt;p&gt;&lt;a href=&#34;?action=login&#34;&gt;Log In&lt;/a&gt;&lt;/p&gt;&#39;;
  }
  die();
}
</code></pre><p>Yes, it&rsquo;s more complicated.</p>
<p>Yes, there are more steps.</p>
<p>But my Google box is back to shouting at me again.</p>
<h2 id="the-future">The Future<a hidden class="anchor" aria-hidden="true" href="#the-future">#</a></h2>
<p>Google are known for changing stuff.</p>
<p>I&rsquo;m sure this authorisation process will change too.</p>
<h2 id="finally">Finally<a hidden class="anchor" aria-hidden="true" href="#finally">#</a></h2>
<p>You might also like to read an 

<a href="https://www.ducktyped.org/p/an-illustrated-guide-to-oauth" target="_blank" rel="nofollow noopener noreferrer">illustrated guide to OAuth</a>
, though by now you are probably fed up with the whole thing.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://boffinsblog.github.io/tags/google-aiy/">Google AIY</a></li>
      <li><a href="https://boffinsblog.github.io/tags/hardware/">Hardware</a></li>
      <li><a href="https://boffinsblog.github.io/tags/raspberry-pi/">Raspberry Pi</a></li>
      <li><a href="https://boffinsblog.github.io/tags/software/">Software</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://boffinsblog.github.io/posts/unbricking-a-sheevaplug/">
    <span class="title">« Prev</span>
    <br>
    <span>Unbricking a SheevaPlug</span>
  </a>
  <a class="next" href="https://boffinsblog.github.io/posts/dumping-google/">
    <span class="title">Next »</span>
    <br>
    <span>Dumping Google</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://boffinsblog.github.io/">Boffins Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <br>
        <p><a href="https://www.creativecommons.org/licenses/by-nc/4.0/deed.en" rel="noopener noreferrer" target="_blank">This work is licensed under CC BY-NC-SA 4.0</a></p>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
