<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Calckey Fediverse Server | Boffins Blog</title>
<meta name="keywords" content="Bash, Fediverse, Linux, Raspberry Pi, Self Hosting, Web-Servers">
<meta name="description" content="Scripts and cron jobs to backup and restore the PostgreSQL database and Calckey files.">
<meta name="author" content="Boffin">
<link rel="canonical" href="https://boffinsblog.github.io/posts/calckey-fediverse-server/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e13be8719bbabf4005d0d2b0f19dba897f7d41b2e807b64c47ee1436d126ab01.css" integrity="sha256-4TvocZu6v0AF0NKw8Z26iX99QbLoB7ZMR&#43;4UNtEmqwE=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://boffinsblog.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://boffinsblog.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://boffinsblog.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://boffinsblog.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://boffinsblog.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://boffinsblog.github.io/posts/calckey-fediverse-server/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:url" content="https://boffinsblog.github.io/posts/calckey-fediverse-server/">
  <meta property="og:site_name" content="Boffins Blog">
  <meta property="og:title" content="Calckey Fediverse Server">
  <meta property="og:description" content="Scripts and cron jobs to backup and restore the PostgreSQL database and Calckey files.">
  <meta property="og:locale" content="en-gb">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-19T14:37:48+01:00">
    <meta property="article:modified_time" content="2023-06-19T14:37:48+01:00">
    <meta property="article:tag" content="Bash">
    <meta property="article:tag" content="Fediverse">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Raspberry Pi">
    <meta property="article:tag" content="Self Hosting">
    <meta property="article:tag" content="Web-Servers">
    <meta property="og:image" content="https://boffinsblog.github.io/posts/calckey-fediverse-server/01_pgAdmin_Screenshot.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://boffinsblog.github.io/posts/calckey-fediverse-server/01_pgAdmin_Screenshot.webp">
<meta name="twitter:title" content="Calckey Fediverse Server">
<meta name="twitter:description" content="Scripts and cron jobs to backup and restore the PostgreSQL database and Calckey files.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://boffinsblog.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Calckey Fediverse Server",
      "item": "https://boffinsblog.github.io/posts/calckey-fediverse-server/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Calckey Fediverse Server",
  "name": "Calckey Fediverse Server",
  "description": "Scripts and cron jobs to backup and restore the PostgreSQL database and Calckey files.",
  "keywords": [
    "Bash", "Fediverse", "Linux", "Raspberry Pi", "Self Hosting", "Web-Servers"
  ],
  "articleBody": "Calckey? Clacky? Is this thing on? I had been itching to set up a Fediverse server for some time but was undecided on the flavour; Mastodon or Calckey or something entirely different?\nCalckey was the eventual winner.\nWhy?\nBecause the Mastodon install was “follow these quick 45 steps in a Terminal”.\nWhich then breaks at step 44.\nCalckey was “run this one script and answer a couple of questions”.\nThis sounds like I’m not a Mastodon fan.\nI am.\nBut.\nCalckey vs Mastodon There are a couple of things that I think Mastodon does really well especially around how to manage your social graph.\nYou can bulk select people to follow and unfollow\nYou can see when someone was last active\nPosts can be set to auto delete after a set period of time\nCalckey does none of the above and I wish it did.\nInstead, Calckey presents who you follow in a lovely looking grid but you have no idea if the following is mutual or when they were last active until you click through to the account details.\nEdit: the Android ‘Milktea’ app currently does show you if the account you are following is following you back.\nFor perspective, I’ve hopped around the Fediverse for a while now with different usernames on different services running different software.\nI have bots that run when my lights turn on and I’ve already written about how to nuke a Mastodon account .\nSo why my delay in setting a Fediverse server up?\nWell, one of the reasons for my reticence around self-hosting was moving my social graph to a server that lives under the telly.\nAnd then something catastrophic happening.\nWhich will occur at some point.\nSo for me to feel comfortable there needed to be a robust backup process in place.\n(And obviously a working restore process.)\nFediverse Server Backup Process I use ‘pg_basebackup’ to take a full copy of the PostgreSQL database.\nI also tried ‘pg_dump’ and ‘pg_restore’ for the Calckey database but I couldn’t get it to restore properly.\nTo run ‘pg_basebackup’ it needs a username / password combination to run.\nFortunately, PostgreSQL has the ability to store this username / password combo in a file.\n.pgpass The file .pgpass in a user’s home directory can contain passwords to be used if the connection requires a password\nhttps://www.postgresql.org/docs/current/libpq-pgpass.htm Obviously it needs creating, and appropriate permissions granting.\nFirst, create the .pgpass file:\nsudo nano /home/$USER/.pgpass\n#hostname:port:database:username:password :hostname:port:ThePostgresAccount:ThePostgresAccountPassword Then own it:\nsudo chown $USER:$USER /home/$USER/.pgpass\nThen give the file the correct permissions:\nchmod 600 /home/$USER/.pgpass\nFinally, write it to the environment variables:\nexport PGPASSFILE='/home/$USER/.pgpass'\nThen, check the environment variable using:\nenv\nThe ‘pg_basebackup’ command will now not ask for a password:\npg_basebackup -h localhost -p 5432 -U postgres_user -D /path/to/the/remote/backup -Fp -Xs -P\nBackup the Calckey database Create the database backup script:\nsudo nano /etc/init.d/backup_calckey_db.sh\nGive the file the correct permissions:\nsudo chmod +x /etc/init.d/backup_calckey_db.sh\nbackup_calckey_db.sh #!/bin/bash # The remote backup process # ~~~~~~~~~~~~~~~~~~~~~~~~~ # Backup the whole of the PostgreSQL database rm -R /home/foo/Backups/calckey/postgresql/*; pg_basebackup -h localhost -p 5432 -U postgres -D /home/foo/Backups/calckey/postgresql -Fp -Xs -P; Backup the Calckey /files/ directory The calckey/files/ directory holds all of the ‘Drive’ files.\n(All of those avatars, headers, wallpapers and meme collections.)\nCreate the /files/ backup script:\nsudo nano /etc/init.d/backup_calckey_files.sh\nGive the file the correct permissions:\nsudo chmod +x /etc/init.d/backup_calckey_files.sh\nbackup_calckey_files.sh #!/bin/bash # The remote backup process # ~~~~~~~~~~~~~~~~~~~~~~~~~ # Backup the Calckey /files/ directory rm -r /home/foo/Backups/calckey/files/ cp -r /home/calckey/calckey/files /home/foo/Backups/calckey/files/ Because the /files/ directory is owned by the Calckey user it needs a sudo cron job.\nsudo crontab -e\n# # Backup the Calckey /files/ directory hourly 0 * * * * sh /etc/init.d/backup_calckey_files.sh # Archive the two backups Obviously the database and the files directory backups need to be in place prior to archiving.\nCreate the archive script:\nsudo nano /etc/init.d/backup_calckey_zipped.sh\nGive the file the correct permissions:\nsudo chmod +x /etc/init.d/backup_calckey_zipped.sh\nbackup_calckey_zipped.sh #!/bin/bash # The remote backup process # ~~~~~~~~~~~~~~~~~~~~~~~~~ # # Backup the whole of the PostgreSQL database # Is called by the user crontab '/etc/init.d/backup_calckey_db.sh' # # Backup the Calckey /files/ directory # Is called by the sudo crontab '/etc/init.d/backup_calckey_files.sh' # # So call this in normal crontab after '/etc/init.d/backup_calckey_db.sh' rm /home/foo/Backups/backup_calckey.zip; zip -r /home/foo/Backups/backup_calckey.zip /home/foo/Backups/calckey I backup the whole PostgreSQL and the /files/ database hourly using cron.\nThen archive (zip) the whole lot.\ncrontab -e\n# # Backup the whole of the PostgreSQL database hourly # Then put the previous /files/ backup and this db backup into one zip 0 * * * * sh /etc/init.d/backup_calckey_db.sh; sh /etc/init.d/backup_calckey_zipped.sh # Fediverse Server Restore Process Obviously there is no sense in keeping a server backup on the server where the original files are held.\nThat’s why there are two backups:\nA pair of folders on the server containing the database and the needed files\nA single zipped file that can be copied as part of a daily backup routine off the server\nThis way, I can easily restore from the hourly created server files and in the case of a yet-to-happen catastrophic event I can copy over the last locally held zip archive and restore from there.\nI’m not going to cover how to get the zip archive on and off the server (hint: I use ssh keys and scp).\nHowever the following script executed server-side will restore (and give the correct permissions to) a Calckey PostgreSQL database and the /files/ directory.\nFirst, create the restore script:\nsudo nano /etc/init.d/restore_calckey.sh\nThen give the file the correct permissions:\nsudo chmod +x /etc/init.d/restore_calckey.sh\nFiles restore_calckey.sh #!/bin/bash # The remote restore process # ~~~~~~~~~~~~~~~~~~~~~~~~~~ # # Restore from the hourly backup on the server clear # Stop the running PostgreSQL service echo -e \"\\e[1;33mStop the running PostgreSQL service...\\e[0m\" sudo systemctl stop postgresql.service echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Current PostgreSQL status echo -e \"\\e[1;33mCurrent PostgreSQL status...\\e[0m\" sudo systemctl status postgresql echo -e \"\\e[32mDone\\e[0m\" echo \"\" # chown the existing PostgreSQL installation echo -e \"\\e[1;33mchown the existing PostgreSQL installation...\\e[0m\" sudo chown -R foo:foo /var/lib/postgresql/15/main/ echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Remove the existing PostgreSQL files echo -e \"\\e[1;33mRemove the existing PostgreSQL files...\\e[0m\" sudo rm -fr /var/lib/postgresql/15/main/* echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Copy the latest backup to the PostgreSQL target location echo -e \"\\e[1;33mCopy the latest backup to the PostgreSQL target location...\\e[0m\" sudo cp -R /home/foo/Backups/calckey/postgresql/* /var/lib/postgresql/15/main/ echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Make the PostgreSQL user take ownership of the target location echo -e \"\\e[1;33mMake the PostgreSQL user take ownership of the target location...\\e[0m\" sudo chown -R postgres:postgres /var/lib/postgresql/15/main/ echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Start the PostgreSQL service echo -e \"\\e[1;33mStart the PostgreSQL service...\\e[0m\" sudo systemctl start postgresql.service echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Current PostgreSQL status echo -e \"\\e[1;33mCurrent PostgreSQL status...\\e[0m\" sudo systemctl status postgresql echo -e \"\\e[32mDone\\e[0m\" echo \"\" # Restore the calckey /files/ directory echo -e \"\\e[1;33mRestore the calckey /files/ directory...\\e[0m\" sudo cp /home/foo/Backups/calckey/files/* /home/calckey/calckey/files echo -e \"\\e[32mDone\\e[0m\" echo \"\" The script needs running using:\nbash /etc/init.d/restore_calckey.sh\nTo see the correctly coloured prompts.\nSome extra notes on running my Calckey Fediverse Server Federation Federation was straightforward and happened rather quickly.\nI posted that this was a new, self-hosted instance and would appreciate a boost; within a couple of days I was federated with over 300 other Fediverse servers (instances).\nTweaking my Calckey Fediverse Server Right now this is a single user instance so it’s just me.\nI’ve turned off the Global Timeline as it was whizzing past far too quickly\nI’ve also turned off the Local Timeline as there are no other people on the server.\nTo save space I’ve also set the files to not cache.\nFinally For anyone interested in getting into the SQL side, pgAdmin is useful.\nI installed it using.\ncurl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg\nsudo sh -c 'echo \"deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/jammy pgadmin4 main\" \u003e /etc/apt/sources.list.d/pgadmin4.list \u0026\u0026 apt update'\nsudo apt update\nsudo apt install pgadmin4\npgAdmin Screenshot\nAnyway, if you feel like following I’m no longer using Calckey; it rebranded to Firefish and then died a slow death.\nAll of the Calckey code examples can also be found at , along with some SQL Snippets .\nHowever you Fediverse, Enjoy!\n",
  "wordCount" : "1362",
  "inLanguage": "en",
  "image":"https://boffinsblog.github.io/posts/calckey-fediverse-server/01_pgAdmin_Screenshot.webp","datePublished": "2023-06-19T14:37:48+01:00",
  "dateModified": "2023-06-19T14:37:48+01:00",
  "author":{
    "@type": "Person",
    "name": "Boffin"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://boffinsblog.github.io/posts/calckey-fediverse-server/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Boffins Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://boffinsblog.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://boffinsblog.github.io/" accesskey="h" title="Boffins Blog (Alt + H)">Boffins Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://boffinsblog.github.io/categories/featured/" title="Featured">
                    <span>Featured</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://boffinsblog.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://boffinsblog.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Calckey Fediverse Server
    </h1>
    <div class="post-meta"><span title='2023-06-19 14:37:48 +0100 BST'>June 19, 2023</span>&nbsp;·&nbsp;<span>7 min</span>&nbsp;·&nbsp;<span>Boffin</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#calckey-clacky-is-this-thing-on" aria-label="Calckey? Clacky? Is this thing on?">Calckey? Clacky? Is this thing on?</a></li>
                <li>
                    <a href="#calckey-vs-mastodon" aria-label="Calckey vs Mastodon">Calckey vs Mastodon</a></li>
                <li>
                    <a href="#fediverse-server-backup-process" aria-label="Fediverse Server Backup Process">Fediverse Server Backup Process</a><ul>
                        
                <li>
                    <a href="#pgpass" aria-label=".pgpass">.pgpass</a></li>
                <li>
                    <a href="#backup-the-calckey-database" aria-label="Backup the Calckey database">Backup the Calckey database</a></li>
                <li>
                    <a href="#backup-the-calckey-files-directory" aria-label="Backup the Calckey /files/ directory">Backup the Calckey /files/ directory</a></li>
                <li>
                    <a href="#archive-the-two-backups" aria-label="Archive the two backups">Archive the two backups</a></li></ul>
                </li>
                <li>
                    <a href="#fediverse-server-restore-process" aria-label="Fediverse Server Restore Process">Fediverse Server Restore Process</a><ul>
                        
                <li>
                    <a href="#files" aria-label="Files">Files</a></li></ul>
                </li>
                <li>
                    <a href="#some-extra-notes-on-running-my-calckey-fediverse-server" aria-label="Some extra notes on running my Calckey Fediverse Server">Some extra notes on running my Calckey Fediverse Server</a><ul>
                        
                <li>
                    <a href="#federation" aria-label="Federation">Federation</a></li>
                <li>
                    <a href="#tweaking-my-calckey-fediverse-server" aria-label="Tweaking my Calckey Fediverse Server">Tweaking my Calckey Fediverse Server</a></li></ul>
                </li>
                <li>
                    <a href="#finally" aria-label="Finally">Finally</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="calckey-clacky-is-this-thing-on">Calckey? Clacky? Is this thing on?<a hidden class="anchor" aria-hidden="true" href="#calckey-clacky-is-this-thing-on">#</a></h2>
<p>I had been itching to set up a Fediverse server for some time but was undecided on the flavour; Mastodon or Calckey or something entirely different?</p>
<p>Calckey was the eventual winner.</p>
<p>Why?</p>
<p>Because the Mastodon install was “follow these quick 45 steps in a Terminal”.</p>
<p>Which then breaks at step 44.</p>
<p>Calckey was “run this one script and answer a couple of questions”.</p>
<p>This sounds like I’m not a Mastodon fan.</p>
<p>I am.</p>
<p>But.</p>
<h2 id="calckey-vs-mastodon">Calckey vs Mastodon<a hidden class="anchor" aria-hidden="true" href="#calckey-vs-mastodon">#</a></h2>
<p>There are a couple of things that I think Mastodon does really well especially around how to manage your social graph.</p>
<ul>
<li>
<p>You can bulk select people to follow and unfollow</p>
</li>
<li>
<p>You can see when someone was last active</p>
</li>
<li>
<p>Posts can be set to auto delete after a set period of time</p>
</li>
</ul>
<p>Calckey does none of the above and I wish it did.</p>
<p>Instead, Calckey presents who you follow in a lovely looking grid but you have no idea if the following is mutual or when they were last active until you click through to the account details.</p>
<p><strong>Edit:</strong> the Android ‘Milktea’ app currently <em>does</em> show you if the account you are following is following you back.</p>
<p>For perspective, I’ve hopped around the Fediverse for a while now with different usernames on different services running different software.</p>
<p>I have 


  <a href="/posts/mastodon-ifttt-bot/">bots that run when my lights turn on</a>
 and I’ve already written about 


  <a href="/posts/delete-your-mastodon-favourites/">how to nuke a Mastodon account</a>
.</p>
<p>So why <em><strong>my</strong></em> delay in setting a Fediverse server up?</p>
<p>Well, one of the reasons for my reticence around self-hosting was moving my social graph to a server that lives under the telly.</p>
<p>And then something catastrophic happening.</p>
<p>Which <em><strong>will</strong></em> occur at some point.</p>
<p>So for me to feel comfortable there needed to be a robust backup process in place.</p>
<p>(And obviously a working restore process.)</p>
<h2 id="fediverse-server-backup-process">Fediverse Server Backup Process<a hidden class="anchor" aria-hidden="true" href="#fediverse-server-backup-process">#</a></h2>
<p>I use <em>‘pg_basebackup’</em> to take a full copy of the PostgreSQL database.</p>
<p>I also tried <em>‘pg_dump’</em> and <em>‘pg_restore’</em> for the Calckey database but I couldn’t get it to restore properly.</p>
<p>To run <em>‘pg_basebackup’</em> it needs a username / password combination to run.</p>
<p>Fortunately, PostgreSQL has the ability to store this username / password combo in a file.</p>
<h3 id="pgpass">.pgpass<a hidden class="anchor" aria-hidden="true" href="#pgpass">#</a></h3>
<blockquote>
<p>The file <code>.pgpass</code> in a user’s home directory can contain passwords to be used if the connection requires a password</p>
<p><em>

<a href="https://www.postgresql.org/docs/current/libpq-pgpass.htm" target="_blank" rel="nofollow noopener noreferrer">https://www.postgresql.org/docs/current/libpq-pgpass.htm</a>
</em></p></blockquote>
<p>Obviously it needs creating, and appropriate permissions granting.</p>
<p>First, create the .pgpass file:</p>
<p><code>sudo nano /home/$USER/.pgpass</code></p>
<pre tabindex="0"><code>#hostname:port:database:username:password
:hostname:port:ThePostgresAccount:ThePostgresAccountPassword
</code></pre><p>Then own it:</p>
<p><code>sudo chown $USER:$USER /home/$USER/.pgpass</code></p>
<p>Then give the file the correct permissions:</p>
<p><code>chmod 600 /home/$USER/.pgpass</code></p>
<p>Finally, write it to the environment variables:</p>
<p><code>export PGPASSFILE='/home/$USER/.pgpass'</code></p>
<p>Then, check the environment variable using:</p>
<p><code>env</code></p>
<p>The <em>‘pg_basebackup’</em> command will now not ask for a password:</p>
<p><code>pg_basebackup -h localhost -p 5432 -U postgres_user -D /path/to/the/remote/backup -Fp -Xs -P</code></p>
<h3 id="backup-the-calckey-database">Backup the Calckey database<a hidden class="anchor" aria-hidden="true" href="#backup-the-calckey-database">#</a></h3>
<p>Create the database backup script:</p>
<p><code>sudo nano /etc/init.d/backup_calckey_db.sh</code></p>
<p>Give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/backup_calckey_db.sh</code></p>
<h4 id="backup_">

<a href="https://github.com/BoffinsBlog/Calckey/blob/main/backup/backup_calckey_db.sh" target="_blank" rel="nofollow noopener noreferrer">backup_calckey_db.sh</a>
</h4>
<pre tabindex="0"><code>#!/bin/bash

# The remote backup process
# ~~~~~~~~~~~~~~~~~~~~~~~~~
# Backup the whole of the PostgreSQL database
rm -R /home/foo/Backups/calckey/postgresql/*;
pg_basebackup -h localhost -p 5432 -U postgres -D /home/foo/Backups/calckey/postgresql -Fp -Xs -P;
</code></pre><h3 id="backup-the-calckey-files-directory">Backup the Calckey /files/ directory<a hidden class="anchor" aria-hidden="true" href="#backup-the-calckey-files-directory">#</a></h3>
<p>The calckey/files/ directory holds all of the ‘Drive’ files.</p>
<p>(All of those avatars, headers, wallpapers and meme collections.)</p>
<p>Create the /files/ backup script:</p>
<p><code>sudo nano /etc/init.d/backup_calckey_files.sh</code></p>
<p>Give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/backup_calckey_files.sh</code></p>
<h4 id="backup_-1">

<a href="https://github.com/BoffinsBlog/Calckey/blob/main/backup/backup_calckey_files.sh" target="_blank" rel="nofollow noopener noreferrer">backup_calckey_files.sh</a>
</h4>
<pre tabindex="0"><code>#!/bin/bash

# The remote backup process
# ~~~~~~~~~~~~~~~~~~~~~~~~~
# Backup the Calckey /files/ directory
rm -r /home/foo/Backups/calckey/files/
cp -r /home/calckey/calckey/files /home/foo/Backups/calckey/files/
</code></pre><p>Because the /files/ directory is owned by the Calckey user it needs a <code>sudo</code> cron job.</p>
<p><code>sudo crontab -e</code></p>
<pre tabindex="0"><code>#
# Backup the Calckey /files/ directory hourly
0 * * * * sh /etc/init.d/backup_calckey_files.sh
#
</code></pre><h3 id="archive-the-two-backups">Archive the two backups<a hidden class="anchor" aria-hidden="true" href="#archive-the-two-backups">#</a></h3>
<p>Obviously the database and the files directory backups need to be in place prior to archiving.</p>
<p>Create the archive script:</p>
<p><code>sudo nano /etc/init.d/backup_calckey_zipped.sh</code></p>
<p>Give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/backup_calckey_zipped.sh</code></p>
<h4 id="backup_-2">

<a href="https://github.com/BoffinsBlog/Calckey/blob/main/backup/backup_calckey_zipped.sh" target="_blank" rel="nofollow noopener noreferrer">backup_calckey_zipped.sh</a>
</h4>
<pre tabindex="0"><code>#!/bin/bash

# The remote backup process
# ~~~~~~~~~~~~~~~~~~~~~~~~~
#
# Backup the whole of the PostgreSQL database
# Is called by the user crontab &#39;/etc/init.d/backup_calckey_db.sh&#39;
#
# Backup the Calckey /files/ directory
# Is called by the sudo crontab &#39;/etc/init.d/backup_calckey_files.sh&#39;
#
#  So call this in normal crontab after &#39;/etc/init.d/backup_calckey_db.sh&#39;
rm /home/foo/Backups/backup_calckey.zip;
zip -r /home/foo/Backups/backup_calckey.zip /home/foo/Backups/calckey
</code></pre><p>I backup the whole PostgreSQL and the /files/ database hourly using cron.</p>
<p>Then archive (zip) the whole lot.</p>
<p><code>crontab -e</code></p>
<pre tabindex="0"><code>#
# Backup the whole of the PostgreSQL database hourly
# Then put the previous /files/ backup and this db backup into one zip
0 * * * * sh /etc/init.d/backup_calckey_db.sh; sh /etc/init.d/backup_calckey_zipped.sh
#
</code></pre><h2 id="fediverse-server-restore-process">Fediverse Server Restore Process<a hidden class="anchor" aria-hidden="true" href="#fediverse-server-restore-process">#</a></h2>
<p>Obviously there is no sense in keeping a server backup on the server where the original files are held.</p>
<p>That’s why there are <strong>two</strong> backups:</p>
<ul>
<li>
<p>A pair of folders <em><strong>on</strong></em> the server containing the database and the needed files</p>
</li>
<li>
<p>A single zipped file that can be copied as part of a daily backup routine <em><strong>off</strong></em> the server</p>
</li>
</ul>
<p>This way, I can easily restore from the hourly created server files and in the case of a yet-to-happen catastrophic event I can copy over the last locally held zip archive and restore from there.</p>
<p>I’m not going to cover how to get the zip archive <em><strong>on</strong></em> and <em><strong>off</strong></em> the server (hint: I use <code>ssh</code> keys and <code>scp</code>).</p>
<p>However the following script executed server-side will restore (and give the correct permissions to) a Calckey PostgreSQL database and the /files/ directory.</p>
<p>First, create the restore script:</p>
<p><code>sudo nano /etc/init.d/restore_calckey.sh</code></p>
<p>Then give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/restore_calckey.sh</code></p>
<h3 id="files">Files<a hidden class="anchor" aria-hidden="true" href="#files">#</a></h3>
<h4 id="restore_">

<a href="https://github.com/BoffinsBlog/Calckey/blob/main/restore/restore_calckey.sh" target="_blank" rel="nofollow noopener noreferrer">restore_calckey.sh</a>
</h4>
<pre tabindex="0"><code>#!/bin/bash

# The remote restore process
# ~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# Restore from the hourly backup on the server

clear

# Stop the running PostgreSQL service
echo -e &#34;\e[1;33mStop the running PostgreSQL service...\e[0m&#34;
sudo systemctl stop postgresql.service
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Current PostgreSQL status
echo -e &#34;\e[1;33mCurrent PostgreSQL status...\e[0m&#34;
sudo systemctl status postgresql
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# chown the existing PostgreSQL installation
echo -e &#34;\e[1;33mchown the existing PostgreSQL installation...\e[0m&#34;
sudo chown -R foo:foo /var/lib/postgresql/15/main/
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Remove the existing PostgreSQL files
echo -e &#34;\e[1;33mRemove the existing PostgreSQL files...\e[0m&#34;
sudo rm -fr /var/lib/postgresql/15/main/*
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Copy the latest backup to the PostgreSQL target location
echo -e &#34;\e[1;33mCopy the latest backup to the PostgreSQL target location...\e[0m&#34;
sudo cp -R /home/foo/Backups/calckey/postgresql/* /var/lib/postgresql/15/main/
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Make the PostgreSQL user take ownership of the target location
echo -e &#34;\e[1;33mMake the PostgreSQL user take ownership of the target location...\e[0m&#34;
sudo chown -R postgres:postgres /var/lib/postgresql/15/main/
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Start the PostgreSQL service
echo -e &#34;\e[1;33mStart the PostgreSQL service...\e[0m&#34;
sudo systemctl start postgresql.service
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Current PostgreSQL status
echo -e &#34;\e[1;33mCurrent PostgreSQL status...\e[0m&#34;
sudo systemctl status postgresql
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;

# Restore the calckey /files/ directory
echo -e &#34;\e[1;33mRestore the calckey /files/ directory...\e[0m&#34;
sudo cp /home/foo/Backups/calckey/files/* /home/calckey/calckey/files
echo -e &#34;\e[32mDone\e[0m&#34;
echo &#34;&#34;
</code></pre><p>The script needs running using:</p>
<p><code>bash /etc/init.d/restore_calckey.sh</code></p>
<p>To see the correctly coloured prompts.</p>
<h2 id="some-extra-notes-on-running-my-calckey-fediverse-server">Some extra notes on running my Calckey Fediverse Server<a hidden class="anchor" aria-hidden="true" href="#some-extra-notes-on-running-my-calckey-fediverse-server">#</a></h2>
<h3 id="federation">Federation<a hidden class="anchor" aria-hidden="true" href="#federation">#</a></h3>
<p>Federation was straightforward and happened rather quickly.</p>
<p>I posted that this was a new, self-hosted instance and would appreciate a boost; within a couple of days I was federated with over 300 other Fediverse servers (instances).</p>
<h3 id="tweaking-my-calckey-fediverse-server">Tweaking <em>my</em> Calckey Fediverse Server<a hidden class="anchor" aria-hidden="true" href="#tweaking-my-calckey-fediverse-server">#</a></h3>
<p>Right now this is a single user instance so it’s just me.</p>
<p>I’ve turned off the <strong>Global Timeline</strong> as it was whizzing past far too quickly</p>
<p>I’ve also turned off the <strong>Local Timeline</strong> as there are no other people on the server.</p>
<p>To save space I’ve also set the files to not cache.</p>
<h2 id="finally">Finally<a hidden class="anchor" aria-hidden="true" href="#finally">#</a></h2>
<p>For anyone interested in getting into the SQL side, pgAdmin is useful.</p>
<p>I installed it using.</p>
<p><code>curl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg</code></p>
<p><code>sudo sh -c 'echo &quot;deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/jammy pgadmin4 main&quot; &gt; /etc/apt/sources.list.d/pgadmin4.list &amp;&amp; apt update'</code></p>
<p><code>sudo apt update</code></p>
<p><code>sudo apt install pgadmin4</code></p>
<p><img alt="A screenshot of the Linux application pgAdmin, used to administer PostgreSQL databases. The Calckey Fediverse Server uses PostgreSQL as its back end database engine." loading="lazy" src="/posts/calckey-fediverse-server/01_pgAdmin_Screenshot.webp#center" title="A screenshot of the Linux application pgAdmin, used to administer PostgreSQL databases. The Calckey Fediverse Server uses PostgreSQL as its back end database engine.">
<em>pgAdmin Screenshot</em></p>
<p>Anyway, if you feel like following I’m no longer using Calckey; it rebranded to Firefish and then died a slow death.</p>
<p>All of the Calckey code examples can also be found 

<a href="https://github.com/BoffinsBlog/Calckey/" target="_blank" rel="nofollow noopener noreferrer">at</a>
, along with some 

<a href="https://github.com/BoffinsBlog/Calckey/tree/main/sql/" target="_blank" rel="nofollow noopener noreferrer">SQL Snippets</a>
.</p>
<p>However you Fediverse, Enjoy!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://boffinsblog.github.io/tags/bash/">Bash</a></li>
      <li><a href="https://boffinsblog.github.io/tags/fediverse/">Fediverse</a></li>
      <li><a href="https://boffinsblog.github.io/tags/linux/">Linux</a></li>
      <li><a href="https://boffinsblog.github.io/tags/raspberry-pi/">Raspberry Pi</a></li>
      <li><a href="https://boffinsblog.github.io/tags/self-hosting/">Self Hosting</a></li>
      <li><a href="https://boffinsblog.github.io/tags/web-servers/">Web-Servers</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://boffinsblog.github.io/posts/firefish-backup-and-restore/">
    <span class="title">« Prev</span>
    <br>
    <span>Firefish Backup and Restore</span>
  </a>
  <a class="next" href="https://boffinsblog.github.io/posts/mastodon-ifttt-bot/">
    <span class="title">Next »</span>
    <br>
    <span>Mastodon / IFTTT Bot</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://boffinsblog.github.io/">Boffins Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <br>
        <p><a href="https://www.creativecommons.org/licenses/by-nc/4.0/deed.en" rel="noopener noreferrer" target="_blank">This work is licensed under CC BY-NC-SA 4.0</a></p>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
