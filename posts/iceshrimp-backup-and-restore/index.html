<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Iceshrimp Backup and Restore | Boffins Blog</title>
<meta name="keywords" content="Bash, Fediverse, Linux, Raspberry Pi, Self Hosting, Web-Servers">
<meta name="description" content="Scripts and cron jobs to backup and restore the Iceshrimp database and Iceshrimp files.">
<meta name="author" content="Boffin">
<link rel="canonical" href="https://boffinsblog.github.io/posts/iceshrimp-backup-and-restore/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e13be8719bbabf4005d0d2b0f19dba897f7d41b2e807b64c47ee1436d126ab01.css" integrity="sha256-4TvocZu6v0AF0NKw8Z26iX99QbLoB7ZMR&#43;4UNtEmqwE=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://boffinsblog.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://boffinsblog.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://boffinsblog.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://boffinsblog.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://boffinsblog.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://boffinsblog.github.io/posts/iceshrimp-backup-and-restore/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:url" content="https://boffinsblog.github.io/posts/iceshrimp-backup-and-restore/">
  <meta property="og:site_name" content="Boffins Blog">
  <meta property="og:title" content="Iceshrimp Backup and Restore">
  <meta property="og:description" content="Scripts and cron jobs to backup and restore the Iceshrimp database and Iceshrimp files.">
  <meta property="og:locale" content="en-gb">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-13T08:10:21+01:00">
    <meta property="article:modified_time" content="2023-09-13T08:10:21+01:00">
    <meta property="article:tag" content="Bash">
    <meta property="article:tag" content="Fediverse">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Raspberry Pi">
    <meta property="article:tag" content="Self Hosting">
    <meta property="article:tag" content="Web-Servers">
    <meta property="og:image" content="https://boffinsblog.github.io/posts/iceshrimp-backup-and-restore/01_Iceshrimp_Script_Screenshot.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://boffinsblog.github.io/posts/iceshrimp-backup-and-restore/01_Iceshrimp_Script_Screenshot.webp">
<meta name="twitter:title" content="Iceshrimp Backup and Restore">
<meta name="twitter:description" content="Scripts and cron jobs to backup and restore the Iceshrimp database and Iceshrimp files.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://boffinsblog.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Iceshrimp Backup and Restore",
      "item": "https://boffinsblog.github.io/posts/iceshrimp-backup-and-restore/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Iceshrimp Backup and Restore",
  "name": "Iceshrimp Backup and Restore",
  "description": "Scripts and cron jobs to backup and restore the Iceshrimp database and Iceshrimp files.",
  "keywords": [
    "Bash", "Fediverse", "Linux", "Raspberry Pi", "Self Hosting", "Web-Servers"
  ],
  "articleBody": "Moar backup Moar restore\nAn Iceshrimp backup and restore process, now with an added Menu.\nWhy? I’ve written in the past about backing up and restoring my Calckey instance and more recently about my Firefish instance.\nAs I refuse to stop tinkering I recently moved to Iceshrimp .\nClearly this needs a backup and restore process too.\nThe Iceshrimp backup and restore process This whole process is a bit simpler than the previous ones.\nFirstly, a backup process takes a copy of the database and creates a tiny file as a flag to say that it completed successfully.\nThe second backup process takes copies of files and creates another tiny file as a flag to say that it has completed successfully.\nThe restore process is a menu asking whether you wish to restore either the database or the files.\nNeither restore process will continue unless the successful completion flag is in place.\nIceshrimp backup The backup process is split into two parts:\nA backup of the Iceshrimp database\nA backup of:\nthe default.yml file\nthe nginx conf\nthe iceshrimp.service file\nthe iceshrimp /files/ directory\nCreate server directories Firstly, ssh into the server and:\nmkdir -p /home/foo/Backups/00.logs\nmkdir -p /home/foo/Backups/10.sites/iceshrimp/database\nmkdir -p /home/foo/Backups/10.sites/iceshrimp/configs/\nmkdir -p /home/foo/Backups/10.sites/iceshrimp/files\n.pgpass .pgpass is a PostgreSQL feature that allows you to securely store the connection information.\nThe file .pgpass in a user’s home directory can contain passwords to be used if the connection requires a password\nhttps://www.postgresql.org/docs/current/libpq-pgpass.html Obviously the .pgpass file needs creating, and appropriate permissions granting.\nFirstly, create the .pgpass file:\nsudo nano /home/$USER/.pgpass\n#hostname:port:database:username:password :hostname:port:ThePostgresAccount:ThePostgresAccountPassword Then, own it:\nsudo chown $USER:$USER /home/$USER/.pgpass\nFinally, give the file the correct permissions:\nchmod 600 /home/$USER/.pgpass\nWrite it to the environment variables:\nexport PGPASSFILE='/home/$USER/.pgpass'\nCheck the environment variable using:\nenv\nThe ‘pg_dump’ command will now not ask for a password:\npg_dump 'iceshrimp' -U postgres -h localhost -p 5432 \u003e \"/home/foo/Backups/10.sites/iceshrimp/database/iceshrimp_backup_database.sql\" -Fc\nBackup the Iceshrimp database This is a flat copy of the Iceshrimp PostgreSQL database, not the whole database as previous backup scripts have created.\nThe script first removes the file showing that a previous backup was successful\nThe removed file is replaced at the end to show that the backup has successfully completed\nThe iceshrimp_restore.sh ‘Restore the ‘iceshrimp_backup_database’ menu option will not run if this file is not in place\nFirstly, create the database backup script:\nsudo nano /etc/init.d/backup_iceshrimp_db.sh\nThen give the file the correct permissions:\nsudo chmod +x /etc/init.d/backup_iceshrimp_db.sh\nbackup_iceshrimp_db.sh #!/bin/bash clear # The iceshrimp database backup process # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ # Remove the file showing that a previous backup was successful echo \"\" echo -e \"\\e[1;33mRemove the file showing that a previous backup was successful...\\e[0m\" rm /home/foo/Backups/00.logs/iceshrimp_backup_database; echo -e \"\\e[32mDone\\e[0m\" # Create a new 'iceshrimp_backup_database' file echo \"\" echo -e \"\\e[1;33mCreate a new 'iceshrimp_backup_database' file...\\e[0m\" pg_dump 'iceshrimp' -U postgres -h localhost -p 5432 \u003e \"/home/foo/Backups/10.sites/iceshrimp/database/iceshrimp_backup_database.sql\" -Fc; echo -e \"\\e[32mDone\\e[0m\" # Create a file to show that the backup has successfully completed echo \"\" echo -e \"\\e[1;33mCreate a file to show that the backup has successfully completed...\\e[0m\" touch /home/foo/Backups/00.logs/iceshrimp_backup_database; echo -e \"\\e[32mDone\\e[0m\" Backup the Iceshrimp files The iceshrimp /files/ directory holds all of the ‘Drive’ files.\n(All of those avatars, headers, wallpapers and meme collections.)\nThe script first removes the file showing that a previous backup was successful\nThe removed file is replaced at the end to show that the backup has successfully completed\nThe iceshrimp_restore.sh ‘Restore the iceshrimp /files/ directory’ menu option will not run if this file is not in place\nFirstly, create the /files/ backup script:\nsudo nano /etc/init.d/backup_iceshrimp_files.sh\nThen, give the file the correct permissions:\nsudo chmod +x /etc/init.d/backup_iceshrimp_files.sh\nbackup_iceshrimp_files.sh #!/bin/bash clear # The files backup process # ~~~~~~~~~~~~~~~~~~~~~~~~ # Remove the file showing that a previous backup was successful echo \"\" echo -e \"\\e[1;33mRemove the file showing that a previous backup was successful...\\e[0m\" rm /home/foo/Backups/00.logs/iceshrimp_backup_files; echo -e \"\\e[32mDone\\e[0m\" # Backup all of the iceshrimp files echo \"\" echo -e \"\\e[1;33mBackup the iceshrimp files...\\e[0m\" # Remove old configs rm -r /home/foo/Backups/10.sites/iceshrimp/configs/*; # # Backup the default.yml cp -r /home/foo/iceshrimp/.config/default.yml /home/foo/Backups/10.sites/iceshrimp/configs/; # # Backup the iceshrimp.nginx.conf cp -r /etc/nginx/sites-available/iceshrimp.nginx.conf /home/foo/Backups/10.sites/iceshrimp/configs/; # # Backup the iceshrimp.service cp -r /etc/systemd/system/iceshrimp.service /home/foo/Backups/10.sites/iceshrimp/configs/; # # Remove old /files/ rm -r /home/foo/Backups/10.sites/iceshrimp/files/*; # # Backup the iceshrimp /files/ directory cp -r /home/foo/iceshrimp/files/. /home/foo/Backups/10.sites/iceshrimp/files/; echo -e \"\\e[32mDone\\e[0m\" # Create a file to show that the backup has successfully completed echo \"\" echo -e \"\\e[1;33mCreate a file to show that the backup has successfully completed...\\e[0m\" touch /home/foo/Backups/00.logs/iceshrimp_backup_files; echo -e \"\\e[32mDone\\e[0m\" Iceshrimp Restore This script creates a small menu that presents two options:\n“Restore the iceshrimp database”: This process will restore the iceshrimp database (if a backup exists)\nCheck to see if a backup has previously completed successfully\nIf a backup is in place then carry on and restore it\n“Restore the iceshrimp /files/ directory”: This process will restore the iceshrimp /files/ (if a backup exists)\nCheck to see if a backup has previously completed successfully\nIf a backup is in place then carry on and restore it\nNOTE: The backup_iceshrimp_files.sh script also creates a copy of the default.yml, the iceshrimp.nginx.conf and the iceshrimp.service files.\nThese files are not part of this restore script and will have to be restored manually.\nTo restore both the database and the /files/ directory, the menu will have to be cycled through twice.\nFirstly, create the restore script:\nsudo nano /etc/init.d/restore_iceshrimp.sh\nThen, give the file the correct permissions:\nsudo chmod +x /etc/init.d/restore_iceshrimp.sh\nrestore_iceshrimp.sh #!/bin/bash HEIGHT=15 WIDTH=75 CHOICE_HEIGHT=4 BACKTITLE=\"Restore iceshrimp database and / or files\" TITLE=\"Restoring Iceshrimp\" MENU=\"Choose one of the following options:\" OPTIONS=(1 \"Restore the iceshrimp database\" 2 \"Restore the iceshrimp /files/ directory\") CHOICE=$(dialog --clear \\ --backtitle \"$BACKTITLE\" \\ --title \"$TITLE\" \\ --menu \"$MENU\" \\ $HEIGHT $WIDTH $CHOICE_HEIGHT \\ \"${OPTIONS[@]}\" \\ 2\u003e\u00261 \u003e/dev/tty) clear case $CHOICE in 1) echo -e \"\\e[1;33mRestoring the iceshrimp database\\e[0m\" echo -e \"\\e[1;33mThis process will restore the iceshrimp database (if a backup exists)\\e[0m\" # Check to see if a backup has previously completed successfully # If a backup is in place then carry on and restore it if [ ! -f /home/foo/Backups/00.logs/iceshrimp_backup_database ]; then # Message echo \"\" echo -e \"\\e[31mNo previous backup to restore!\\e[0m\" else # Restore the 'iceshrimp_backup_database' file echo \"\" echo -e \"\\e[1;33mRestore the 'iceshrimp_backup_database' file' file...\\e[0m\" sleep 2 pg_restore -U postgres -h localhost -p 5432 -d iceshrimp -v \"/home/foo/Backups/10.sites/iceshrimp/database/iceshrimp_backup_database.sql\" # Message echo \"\" echo -e \"\\e[32mRestored the iceshrimp database backup\\e[0m\" fi # Pause sleep 2 # Reload the menu bash /etc/init.d/restore_iceshrimp.sh ;; 2) echo -e \"\\e[1;33mRestoring the iceshrimp /files/ directory\\e[0m\" echo -e \"\\e[1;33mThis process will restore the iceshrimp /files/ (if a backup exists)\\e[0m\" # Check to see if a backup has previously completed successfully # If a backup is in place then carry on and restore it if [ ! -f /home/foo/Backups/00.logs/iceshrimp_backup_files ]; then # Message echo \"\" echo -e \"\\e[31mNo previous backup to restore!\\e[0m\" else # Restore the iceshrimp /files/ directory echo \"\" echo -e \"\\e[1;33mRestore the iceshrimp /files/ directory...\\e[0m\" sleep 2 sudo cp /home/foo/Backups/10.sites/iceshrimp/files/* /home/foo/iceshrimp/files # Message echo \"\" echo -e \"\\e[32mRestored the iceshrimp /files/ directory\\e[0m\" fi # Pause sleep 2 # Reload the menu bash /etc/init.d/restore_iceshrimp.sh ;; esac crontab -e Backup the iceshrimp database daily at midnight by running the script in a normal crontab.\n# # Backup the iceshrimp database daily at midnight 0 0 * * * sh /etc/init.d/backup_iceshrimp_db.sh # sudo crontab -e Backup the iceshrimp files daily at midnight by running the script in a root crontab.\n# # Backup the iceshrimp files daily at midnight 0 0 * * * sh /etc/init.d/backup_iceshrimp_files.sh # Finally (I did mention this in a prior post but it bears repeating.)\nFor anyone interested in getting into the SQL side, pgAdmin is a useful tool.\nI installed it using:\ncurl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg\nsudo sh -c 'echo \"deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/jammy pgadmin4 main\" \u003e /etc/apt/sources.list.d/pgadmin4.list \u0026\u0026 apt update'\nsudo apt update\nsudo apt install pgadmin4\npgAdmin Screenshot\nHowever you Fediverse, Enjoy!\n",
  "wordCount" : "1309",
  "inLanguage": "en",
  "image":"https://boffinsblog.github.io/posts/iceshrimp-backup-and-restore/01_Iceshrimp_Script_Screenshot.webp","datePublished": "2023-09-13T08:10:21+01:00",
  "dateModified": "2023-09-13T08:10:21+01:00",
  "author":{
    "@type": "Person",
    "name": "Boffin"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://boffinsblog.github.io/posts/iceshrimp-backup-and-restore/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Boffins Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://boffinsblog.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://boffinsblog.github.io/" accesskey="h" title="Boffins Blog (Alt + H)">Boffins Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://boffinsblog.github.io/categories/featured/" title="Featured">
                    <span>Featured</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://boffinsblog.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://boffinsblog.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://boffinsblog.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Iceshrimp Backup and Restore
    </h1>
    <div class="post-meta"><span title='2023-09-13 08:10:21 +0100 BST'>September 13, 2023</span>&nbsp;·&nbsp;<span>7 min</span>&nbsp;·&nbsp;<span>Boffin</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#moar-backup" aria-label="Moar backup">Moar backup</a></li>
                <li>
                    <a href="#why" aria-label="Why?">Why?</a></li>
                <li>
                    <a href="#the-iceshrimp-backup-and-restore-process" aria-label="The Iceshrimp backup and restore process">The Iceshrimp backup and restore process</a></li>
                <li>
                    <a href="#iceshrimp-backup" aria-label="Iceshrimp backup">Iceshrimp backup</a><ul>
                        
                <li>
                    <a href="#create-server-directories" aria-label="Create server directories">Create server directories</a></li>
                <li>
                    <a href="#pgpass" aria-label=".pgpass">.pgpass</a></li>
                <li>
                    <a href="#backup-the-iceshrimp-database" aria-label="Backup the Iceshrimp database">Backup the Iceshrimp database</a></li>
                <li>
                    <a href="#backup-the-iceshrimp-files" aria-label="Backup the Iceshrimp files">Backup the Iceshrimp files</a></li></ul>
                </li>
                <li>
                    <a href="#iceshrimp-restore" aria-label="Iceshrimp Restore">Iceshrimp Restore</a></li>
                <li>
                    <a href="#crontab--e" aria-label="crontab -e">crontab -e</a></li>
                <li>
                    <a href="#sudo-crontab--e" aria-label="sudo crontab -e">sudo crontab -e</a></li>
                <li>
                    <a href="#finally" aria-label="Finally">Finally</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="moar-backup">Moar backup<a hidden class="anchor" aria-hidden="true" href="#moar-backup">#</a></h2>
<p>Moar restore</p>
<p>An Iceshrimp backup and restore process, now with an added Menu.</p>
<h2 id="why">Why?<a hidden class="anchor" aria-hidden="true" href="#why">#</a></h2>
<p>I’ve written in the past about backing up and restoring my 


  <a href="/posts/calckey-fediverse-server/">Calckey</a>
 instance and more recently about my 


  <a href="/posts/firefish-backup-and-restore/">Firefish</a>
 instance.</p>
<p>As I refuse to stop tinkering I recently moved to 


  <a href="/posts/installing-iceshrimp/">Iceshrimp</a>
.</p>
<p>Clearly this needs a backup and restore process too.</p>
<h2 id="the-iceshrimp-backup-and-restore-process">The Iceshrimp backup and restore process<a hidden class="anchor" aria-hidden="true" href="#the-iceshrimp-backup-and-restore-process">#</a></h2>
<p>This whole process is a bit simpler than the previous ones.</p>
<p>Firstly, a backup process takes a copy of the database and creates a tiny file as a flag to say that it completed successfully.</p>
<p>The second backup process takes copies of files and creates another tiny file as a flag to say that it has completed successfully.</p>
<p>The restore process is a menu asking whether you wish to restore either the database or the files.</p>
<p>Neither restore process will continue unless the successful completion flag is in place.</p>
<h2 id="iceshrimp-backup">Iceshrimp backup<a hidden class="anchor" aria-hidden="true" href="#iceshrimp-backup">#</a></h2>
<p>The backup process is split into two parts:</p>
<ul>
<li>
<p>A backup of the Iceshrimp database</p>
</li>
<li>
<p>A backup of:</p>
<ul>
<li>
<p>the default.yml file</p>
</li>
<li>
<p>the nginx conf</p>
</li>
<li>
<p>the iceshrimp.service file</p>
</li>
<li>
<p>the iceshrimp /files/ directory</p>
</li>
</ul>
</li>
</ul>
<h3 id="create-server-directories">Create server directories<a hidden class="anchor" aria-hidden="true" href="#create-server-directories">#</a></h3>
<p>Firstly, <code>ssh</code> into the server and:</p>
<p><code>mkdir -p /home/foo/Backups/00.logs</code></p>
<p><code>mkdir -p /home/foo/Backups/10.sites/iceshrimp/database</code></p>
<p><code>mkdir -p /home/foo/Backups/10.sites/iceshrimp/configs/</code></p>
<p><code>mkdir -p /home/foo/Backups/10.sites/iceshrimp/files</code></p>
<h3 id="pgpass">.pgpass<a hidden class="anchor" aria-hidden="true" href="#pgpass">#</a></h3>
<p>.pgpass is a PostgreSQL feature that allows you to securely store the connection information.</p>
<blockquote>
<p>The file .pgpass in a user’s home directory can contain passwords to be used if the connection requires a password</p>
<p><em>

<a href="https://www.postgresql.org/docs/current/libpq-pgpass.html" target="_blank" rel="nofollow noopener noreferrer">https://www.postgresql.org/docs/current/libpq-pgpass.html</a>
</em></p></blockquote>
<p>Obviously the .pgpass file needs creating, and appropriate permissions granting.</p>
<p>Firstly, create the .pgpass file:</p>
<p><code>sudo nano /home/$USER/.pgpass</code></p>
<pre tabindex="0"><code>#hostname:port:database:username:password
:hostname:port:ThePostgresAccount:ThePostgresAccountPassword
</code></pre><p>Then, own it:</p>
<p><code>sudo chown $USER:$USER /home/$USER/.pgpass</code></p>
<p>Finally, give the file the correct permissions:</p>
<p><code>chmod 600 /home/$USER/.pgpass</code></p>
<p>Write it to the environment variables:</p>
<p><code>export PGPASSFILE='/home/$USER/.pgpass'</code></p>
<p>Check the environment variable using:</p>
<p><code>env</code></p>
<p>The <em>‘pg_dump’</em> command will now not ask for a password:</p>
<p><code>pg_dump 'iceshrimp' -U postgres -h localhost -p 5432 &gt; &quot;/home/foo/Backups/10.sites/iceshrimp/database/iceshrimp_backup_database.sql&quot; -Fc</code></p>
<h3 id="backup-the-iceshrimp-database">Backup the Iceshrimp database<a hidden class="anchor" aria-hidden="true" href="#backup-the-iceshrimp-database">#</a></h3>
<p>This is a flat copy of the Iceshrimp PostgreSQL database, <strong>not</strong> the whole database as previous backup scripts have created.</p>
<ul>
<li>
<p>The script first removes the file showing that a previous backup was successful</p>
</li>
<li>
<p>The removed file is replaced at the end to show that the backup has successfully completed</p>
</li>
<li>
<p>The 

<a href="https://github.com/BoffinsBlog/Iceshrimp/blob/main/restore/restore_iceshrimp.sh" target="_blank" rel="nofollow noopener noreferrer">iceshrimp_restore.sh</a>
 ‘Restore the ‘iceshrimp_backup_database’ menu option will not run if this file is not in place</p>
</li>
</ul>
<p>Firstly, create the database backup script:</p>
<p><code>sudo nano /etc/init.d/backup_iceshrimp_db.sh</code></p>
<p>Then give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/backup_iceshrimp_db.sh</code></p>
<h4 id="backup_">

<a href="https://github.com/BoffinsBlog/Iceshrimp/blob/main/backup/backup_iceshrimp_db.sh" target="_blank" rel="nofollow noopener noreferrer">backup_iceshrimp_db.sh</a>
</h4>
<pre tabindex="0"><code>#!/bin/bash

clear

# The iceshrimp database backup process
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Remove the file showing that a previous backup was successful
echo &#34;&#34;
echo -e &#34;\e[1;33mRemove the file showing that a previous backup was successful...\e[0m&#34;
rm /home/foo/Backups/00.logs/iceshrimp_backup_database;
echo -e &#34;\e[32mDone\e[0m&#34;

# Create a new &#39;iceshrimp_backup_database&#39; file
echo &#34;&#34;
echo -e &#34;\e[1;33mCreate a new &#39;iceshrimp_backup_database&#39; file...\e[0m&#34;
pg_dump &#39;iceshrimp&#39; -U postgres -h localhost -p 5432 &gt; &#34;/home/foo/Backups/10.sites/iceshrimp/database/iceshrimp_backup_database.sql&#34; -Fc;
echo -e &#34;\e[32mDone\e[0m&#34;

# Create a file to show that the backup has successfully completed
echo &#34;&#34;
echo -e &#34;\e[1;33mCreate a file to show that the backup has successfully completed...\e[0m&#34;
touch /home/foo/Backups/00.logs/iceshrimp_backup_database;
echo -e &#34;\e[32mDone\e[0m&#34;
</code></pre><h3 id="backup-the-iceshrimp-files">Backup the Iceshrimp files<a hidden class="anchor" aria-hidden="true" href="#backup-the-iceshrimp-files">#</a></h3>
<p>The iceshrimp /files/ directory holds all of the ‘Drive’ files.</p>
<p>(All of those avatars, headers, wallpapers and meme collections.)</p>
<ul>
<li>
<p>The script first removes the file showing that a previous backup was successful</p>
</li>
<li>
<p>The removed file is replaced at the end to show that the backup has successfully completed</p>
</li>
<li>
<p>The 

<a href="https://github.com/BoffinsBlog/Iceshrimp/blob/main/restore/restore_iceshrimp.sh" target="_blank" rel="nofollow noopener noreferrer">iceshrimp_restore.sh</a>
 ‘Restore the iceshrimp /files/ directory’ menu option will not run if this file is not in place</p>
</li>
</ul>
<p>Firstly, create the /files/ backup script:</p>
<p><code>sudo nano /etc/init.d/backup_iceshrimp_files.sh</code></p>
<p>Then, give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/backup_iceshrimp_files.sh</code></p>
<h4 id="backup_-1">

<a href="https://github.com/BoffinsBlog/Iceshrimp/blob/main/backup/backup_iceshrimp_files.sh" target="_blank" rel="nofollow noopener noreferrer">backup_iceshrimp_files.sh</a>
</h4>
<pre tabindex="0"><code>#!/bin/bash

clear

# The files backup process
# ~~~~~~~~~~~~~~~~~~~~~~~~
# Remove the file showing that a previous backup was successful
echo &#34;&#34;
echo -e &#34;\e[1;33mRemove the file showing that a previous backup was successful...\e[0m&#34;
rm /home/foo/Backups/00.logs/iceshrimp_backup_files;
echo -e &#34;\e[32mDone\e[0m&#34;

# Backup all of the iceshrimp files
echo &#34;&#34;
echo -e &#34;\e[1;33mBackup the iceshrimp files...\e[0m&#34;
# Remove old configs
rm -r /home/foo/Backups/10.sites/iceshrimp/configs/*;
#
# Backup the default.yml
cp -r /home/foo/iceshrimp/.config/default.yml /home/foo/Backups/10.sites/iceshrimp/configs/;
#
# Backup the iceshrimp.nginx.conf
cp -r /etc/nginx/sites-available/iceshrimp.nginx.conf /home/foo/Backups/10.sites/iceshrimp/configs/;
#
# Backup the iceshrimp.service
cp -r /etc/systemd/system/iceshrimp.service /home/foo/Backups/10.sites/iceshrimp/configs/;
#
# Remove old /files/
rm -r /home/foo/Backups/10.sites/iceshrimp/files/*;
#
# Backup the iceshrimp /files/ directory
cp -r /home/foo/iceshrimp/files/. /home/foo/Backups/10.sites/iceshrimp/files/;
echo -e &#34;\e[32mDone\e[0m&#34;

# Create a file to show that the backup has successfully completed
echo &#34;&#34;
echo -e &#34;\e[1;33mCreate a file to show that the backup has successfully completed...\e[0m&#34;
touch /home/foo/Backups/00.logs/iceshrimp_backup_files;
echo -e &#34;\e[32mDone\e[0m&#34;
</code></pre><h2 id="iceshrimp-restore">Iceshrimp Restore<a hidden class="anchor" aria-hidden="true" href="#iceshrimp-restore">#</a></h2>
<p>This script creates a small menu that presents two options:</p>
<ul>
<li>
<p>“Restore the iceshrimp database”: This process will restore the iceshrimp database (if a backup exists)</p>
<ul>
<li>
<p>Check to see if a backup has previously completed successfully</p>
</li>
<li>
<p>If a backup is in place then carry on and restore it</p>
</li>
</ul>
</li>
<li>
<p>“Restore the iceshrimp /files/ directory”: This process will restore the iceshrimp /files/ (if a backup exists)</p>
<ul>
<li>
<p>Check to see if a backup has previously completed successfully</p>
</li>
<li>
<p>If a backup is in place then carry on and restore it</p>
</li>
</ul>
</li>
</ul>
<p><strong>NOTE:</strong> The 

<a href="https://github.com/BoffinsBlog/Iceshrimp/blob/main/backup/backup_iceshrimp_files.sh" target="_blank" rel="nofollow noopener noreferrer">backup_iceshrimp_files.sh</a>
 script also creates a copy of the <em>default.yml</em>, the <em>iceshrimp.nginx.conf</em> and the <em>iceshrimp.service</em> files.</p>
<p>These files are not part of this restore script and will have to be restored manually.</p>
<p>To restore both the database and the /files/ directory, the menu will have to be cycled through twice.</p>
<p>Firstly, create the restore script:</p>
<p><code>sudo nano /etc/init.d/restore_iceshrimp.sh</code></p>
<p>Then, give the file the correct permissions:</p>
<p><code>sudo chmod +x /etc/init.d/restore_iceshrimp.sh</code></p>
<h3 id="restore_">

<a href="https://github.com/BoffinsBlog/Iceshrimp/blob/main/restore/restore_iceshrimp.sh" target="_blank" rel="nofollow noopener noreferrer">restore_iceshrimp.sh</a>
</h3>
<pre tabindex="0"><code>#!/bin/bash

HEIGHT=15
WIDTH=75
CHOICE_HEIGHT=4
BACKTITLE=&#34;Restore iceshrimp database and / or files&#34;
TITLE=&#34;Restoring Iceshrimp&#34;
MENU=&#34;Choose one of the following options:&#34;

OPTIONS=(1 &#34;Restore the iceshrimp database&#34;
         2 &#34;Restore the iceshrimp /files/ directory&#34;)

CHOICE=$(dialog --clear \
                --backtitle &#34;$BACKTITLE&#34; \
                --title &#34;$TITLE&#34; \
                --menu &#34;$MENU&#34; \
                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                &#34;${OPTIONS[@]}&#34; \
                2&gt;&amp;1 &gt;/dev/tty)

clear

case $CHOICE in
        1)
            echo -e &#34;\e[1;33mRestoring the iceshrimp database\e[0m&#34;
            echo -e &#34;\e[1;33mThis process will restore the iceshrimp database (if a backup exists)\e[0m&#34;

            # Check to see if a backup has previously completed successfully
            # If a backup is in place then carry on and restore it
            if [ ! -f /home/foo/Backups/00.logs/iceshrimp_backup_database ]; then

                # Message
                echo &#34;&#34;
                echo -e &#34;\e[31mNo previous backup to restore!\e[0m&#34;

            else
                # Restore the &#39;iceshrimp_backup_database&#39; file
                echo &#34;&#34;
                echo -e &#34;\e[1;33mRestore the &#39;iceshrimp_backup_database&#39; file&#39; file...\e[0m&#34;
                sleep 2
                pg_restore -U postgres -h localhost -p 5432 -d iceshrimp -v &#34;/home/foo/Backups/10.sites/iceshrimp/database/iceshrimp_backup_database.sql&#34;

                # Message
                echo &#34;&#34;
                echo -e &#34;\e[32mRestored the iceshrimp database backup\e[0m&#34;
            fi

            # Pause
            sleep 2

            # Reload the menu
            bash /etc/init.d/restore_iceshrimp.sh
            ;;
        2)
            echo -e &#34;\e[1;33mRestoring the iceshrimp /files/ directory\e[0m&#34;
            echo -e &#34;\e[1;33mThis process will restore the iceshrimp /files/ (if a backup exists)\e[0m&#34;

            # Check to see if a backup has previously completed successfully
            # If a backup is in place then carry on and restore it
            if [ ! -f /home/foo/Backups/00.logs/iceshrimp_backup_files ]; then

                # Message
                echo &#34;&#34;
                echo -e &#34;\e[31mNo previous backup to restore!\e[0m&#34;

            else
                # Restore the iceshrimp /files/ directory
                echo &#34;&#34;
                echo -e &#34;\e[1;33mRestore the iceshrimp /files/ directory...\e[0m&#34;
                sleep 2
                sudo cp /home/foo/Backups/10.sites/iceshrimp/files/* /home/foo/iceshrimp/files

                # Message
                echo &#34;&#34;
                echo -e &#34;\e[32mRestored the iceshrimp /files/ directory\e[0m&#34;
            fi

            # Pause
            sleep 2

            # Reload the menu
            bash /etc/init.d/restore_iceshrimp.sh
            ;;
esac
</code></pre><h2 id="crontab--e">crontab -e<a hidden class="anchor" aria-hidden="true" href="#crontab--e">#</a></h2>
<p>Backup the iceshrimp database daily at midnight by running the script in a normal crontab.</p>
<pre tabindex="0"><code>#
# Backup the iceshrimp database daily at midnight
0 0 * * * sh /etc/init.d/backup_iceshrimp_db.sh
#
</code></pre><h2 id="sudo-crontab--e">sudo crontab -e<a hidden class="anchor" aria-hidden="true" href="#sudo-crontab--e">#</a></h2>
<p>Backup the iceshrimp files daily at midnight by running the script in a root crontab.</p>
<pre tabindex="0"><code>#
# Backup the iceshrimp files daily at midnight
0 0 * * * sh /etc/init.d/backup_iceshrimp_files.sh
#
</code></pre><h2 id="finally">Finally<a hidden class="anchor" aria-hidden="true" href="#finally">#</a></h2>
<p>(I did mention this in a 


  <a href="/posts/calckey-fediverse-server/">prior post</a>
 but it bears repeating.)</p>
<p>For anyone interested in getting into the SQL side, pgAdmin is a useful tool.</p>
<p>I installed it using:</p>
<p><code>curl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg</code></p>
<p><code>sudo sh -c 'echo &quot;deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/jammy pgadmin4 main&quot; &gt; /etc/apt/sources.list.d/pgadmin4.list &amp;&amp; apt update'</code></p>
<p><code>sudo apt update</code></p>
<p><code>sudo apt install pgadmin4</code></p>
<p><img alt="A screenshot of the Linux application pgAdmin, used to administer PostgreSQL databases. The Calckey Fediverse Server uses PostgreSQL as its back end database engine." loading="lazy" src="/posts/iceshrimp-backup-and-restore/01_pgAdmin_Screenshot.webp#center" title="A screenshot of the Linux application pgAdmin, used to administer PostgreSQL databases. The Calckey Fediverse Server uses PostgreSQL as its back end database engine.">
<em>pgAdmin Screenshot</em></p>
<p>However you Fediverse, Enjoy!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://boffinsblog.github.io/tags/bash/">Bash</a></li>
      <li><a href="https://boffinsblog.github.io/tags/fediverse/">Fediverse</a></li>
      <li><a href="https://boffinsblog.github.io/tags/linux/">Linux</a></li>
      <li><a href="https://boffinsblog.github.io/tags/raspberry-pi/">Raspberry Pi</a></li>
      <li><a href="https://boffinsblog.github.io/tags/self-hosting/">Self Hosting</a></li>
      <li><a href="https://boffinsblog.github.io/tags/web-servers/">Web-Servers</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://boffinsblog.github.io/posts/rss-to-toot/">
    <span class="title">« Prev</span>
    <br>
    <span>RSS to Toot</span>
  </a>
  <a class="next" href="https://boffinsblog.github.io/posts/nanode/">
    <span class="title">Next »</span>
    <br>
    <span>Nanode</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://boffinsblog.github.io/">Boffins Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
        <br>
        <p><a href="https://www.creativecommons.org/licenses/by-nc/4.0/deed.en" rel="noopener noreferrer" target="_blank">This work is licensed under CC BY-NC-SA 4.0</a></p>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
